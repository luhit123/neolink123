import { Patient, Unit } from "../types";

// ============================================================================
// OPENAI API CONFIGURATION - GPT-5.2
// ============================================================================

const getApiKey = () => {
  const apiKey = import.meta.env.VITE_OPENAI_API_KEY;

  if (!apiKey) {
    console.error('Missing VITE_OPENAI_API_KEY environment variable.');
    console.error('Please add your OpenAI API key to the .env file.');
    throw new Error('OpenAI API key is not configured. Please check your .env file.');
  }

  return apiKey;
};

// OpenAI Model Configuration
const OPENAI_MODEL = 'gpt-5.2'; // Primary model
const OPENAI_MODEL_FAST = 'gpt-4o'; // Fallback for faster responses
const OPENAI_MODEL_MINI = 'gpt-4o-mini'; // For simple tasks

// Helper function to call OpenAI GPT
const callOpenAI = async (
  prompt: string,
  systemPrompt?: string,
  options?: {
    model?: string;
    temperature?: number;
    maxTokens?: number;
    jsonMode?: boolean;
  }
): Promise<string> => {
  const apiKey = getApiKey();
  const model = options?.model || OPENAI_MODEL;

  // Determine if this is a newer model that uses max_completion_tokens
  const isNewerModel = model.startsWith('gpt-5') || model.startsWith('o1') || model.startsWith('o3');
  const tokenParam = isNewerModel ? 'max_completion_tokens' : 'max_tokens';

  const requestBody: any = {
    model,
    messages: [
      ...(systemPrompt ? [{ role: 'system', content: systemPrompt }] : []),
      { role: 'user', content: prompt }
    ],
    temperature: options?.temperature ?? 0.3,
    [tokenParam]: options?.maxTokens ?? 2000
  };

  // Add JSON mode if requested
  if (options?.jsonMode) {
    requestBody.response_format = { type: 'json_object' };
  }

  try {
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`
      },
      body: JSON.stringify(requestBody)
    });

    if (!response.ok) {
      const error = await response.json();
      console.error('OpenAI API Error:', error);

      // If GPT-5.2 fails, try fallback to GPT-4o
      if (model === OPENAI_MODEL && (error.error?.code === 'model_not_found' || error.error?.message?.includes('not supported'))) {
        console.warn('GPT-5.2 not available or incompatible, falling back to GPT-4o...');
        return callOpenAI(prompt, systemPrompt, { ...options, model: OPENAI_MODEL_FAST });
      }

      throw new Error(error.error?.message || 'OpenAI API request failed');
    }

    const data = await response.json();
    return data.choices?.[0]?.message?.content?.trim() || '';
  } catch (error: any) {
    console.error('OpenAI request failed:', error);
    throw error;
  }
};

// ============================================================================
// CACHING INFRASTRUCTURE
// ============================================================================

interface CacheEntry {
  result: any;
  timestamp: number;
}

const aiCache = new Map<string, CacheEntry>();
const CACHE_TTL = 5 * 60 * 1000; // 5 minutes

const getCachedResult = (key: string): any | null => {
  const cached = aiCache.get(key);
  if (cached && Date.now() - cached.timestamp < CACHE_TTL) {
    return cached.result;
  }
  return null;
};

const setCachedResult = (key: string, result: any): void => {
  aiCache.set(key, { result, timestamp: Date.now() });
};

// AI Disclaimer for medical outputs
const AI_DISCLAIMER = "\n\n⚠️ AI-Generated Content: This information is generated by AI and should not replace professional clinical judgment. Always verify with current evidence-based guidelines and consult senior clinicians for critical decisions.";

// System prompt for medical AI - writes like an actual treating physician
const MEDICAL_SYSTEM_PROMPT = `You are a senior neonatologist/pediatrician writing clinical documentation.
Write in proper medical documentation style:
- Use passive voice or "Baby/Child was..."
- Be concise and factual
- Write FULL medical terms, not abbreviations (write "room air" not "RA", "antibiotics" not "Abx", "intravenous" not "IV")
- Never speculate or add unconfirmed diagnoses
- Sound like real hospital documentation - professional, clear, and readable`;

// Helper function to build patient context for AI prompts
const buildPatientContext = (patient: Patient): string => {
  const isNeonatal = patient.unit === Unit.NICU || patient.unit === Unit.SNCU;

  const lines: string[] = [];

  // Basic info
  lines.push(`Patient: ${patient.name}`);
  lines.push(`Gender: ${patient.gender}`);
  lines.push(`Unit: ${patient.unit}`);

  if (patient.age !== undefined) {
    lines.push(`Age: ${patient.age} ${patient.ageUnit || 'days'}`);
  }

  // Neonatal specific
  if (isNeonatal) {
    if (patient.birthWeight) lines.push(`Birth Weight: ${patient.birthWeight}g`);
    if (patient.gestationalAgeWeeks !== undefined || patient.gestationalAgeDays !== undefined) {
      lines.push(`Gestational Age: ${patient.gestationalAgeWeeks || 0}+${patient.gestationalAgeDays || 0} weeks`);
    }
    if (patient.modeOfDelivery) lines.push(`Mode of Delivery: ${patient.modeOfDelivery}`);
    if (patient.placeOfDelivery) lines.push(`Place of Delivery: ${patient.placeOfDelivery}`);
    if (patient.maternalHistory) lines.push(`Maternal History: ${JSON.stringify(patient.maternalHistory)}`);
  }

  // Admission info
  lines.push(`Admission Date: ${patient.admissionDate}`);
  lines.push(`Admission Diagnosis: ${patient.diagnosis}`);
  if (patient.diagnosisAtDeath) lines.push(`Diagnosis at Death: ${patient.diagnosisAtDeath}`);
  if (patient.admissionType) lines.push(`Admission Type: ${patient.admissionType}`);

  // Clinical status
  lines.push(`Outcome: ${patient.outcome}`);
  if (patient.dateOfDeath) lines.push(`Date of Death: ${patient.dateOfDeath}`);
  if (patient.releaseDate) lines.push(`Release Date: ${patient.releaseDate}`);

  // Medications
  if (patient.medications && patient.medications.length > 0) {
    const activeMeds = patient.medications.filter(m => m.isActive !== false);
    if (activeMeds.length > 0) {
      lines.push(`Medications: ${activeMeds.map(m => `${m.name} ${m.dose || ''} ${m.frequency || ''}`).join('; ')}`);
    }
  }

  // Progress notes summary
  if (patient.progressNotes && patient.progressNotes.length > 0) {
    const recentNotes = patient.progressNotes.slice(-3);
    lines.push(`Recent Progress Notes (${recentNotes.length}):`);
    recentNotes.forEach(note => {
      const noteText = note.note || 'Vitals recorded';
      lines.push(`- ${note.date}: ${noteText.substring(0, 200)}${noteText.length > 200 ? '...' : ''}`);
    });
  }

  return lines.join('\n');
};

// ============================================================================
// PATIENT SUMMARY & INSIGHTS
// ============================================================================

export const generatePatientSummary = async (patient: Patient): Promise<string> => {
  const cacheKey = `summary-v2.0-${patient.id}-${patient.progressNotes.length}`;
  const cached = getCachedResult(cacheKey);
  if (cached) return cached;

  const notes = patient.progressNotes.map(n => `${new Date(n.date).toLocaleString()}: ${n.note || 'Vitals and examination recorded'}`).join('\n');

  const currentAge = patient.dateOfBirth
    ? `${Math.floor((Date.now() - new Date(patient.dateOfBirth).getTime()) / (1000 * 60 * 60 * 24))} days`
    : `${patient.age} ${patient.ageUnit}`;

  const prompt = `Generate a clinical summary with the following EXACT format. Follow these rules strictly:

CRITICAL RULES:
- NO bullet points
- NO dashes (-)
- NO asterisks (*)
- NO dots at line starts
- NO bars (|, =, _)
- ONLY use section headings and paragraph text
- Keep it simple and clean

OUTPUT THIS EXACT STRUCTURE:

PATIENT PARTICULARS
Name: ${patient.name}
Age: ${currentAge}
Gender: ${patient.gender}
Birth Weight: ${patient.birthWeight ? `${patient.birthWeight} kg` : 'Not recorded'}
Admission Weight: ${patient.weightOnAdmission ? `${patient.weightOnAdmission} kg` : 'Not recorded'}
Admission Date: ${new Date(patient.admissionDate).toLocaleDateString()}
Indication for Admission: ${patient.indicationsForAdmission?.join(', ') || patient.customIndication || patient.diagnosis}
Unit: ${patient.unit}

DIAGNOSIS
${patient.diagnosis}

CLINICAL SUMMARY
Based on these notes: ${notes || 'No detailed clinical notes available'}
Write 2-3 sentences describing the patient's hospital course and key clinical events in paragraph format.

CURRENT STATUS
Write 2-3 sentences describing current clinical condition and stability in paragraph format.

ADVICE
Write 2-4 sentences with management recommendations and follow-up plan in paragraph format. Include monitoring parameters and key actions needed.

REMEMBER: Use ONLY the section headings shown above followed by paragraph text. NO symbols, NO bullets, NO dashes, NO dots except in sentences.`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT);
    setCachedResult(cacheKey, result);
    return result;
  } catch (error) {
    console.error("Error generating summary with OpenAI:", error);
    return "Error: Could not generate summary. The AI model may be unavailable or there might be an issue with the API key.";
  }
};

export const getClinicalInsights = async (patient: Patient): Promise<string> => {
  const cacheKey = `insights-${patient.id}-${patient.diagnosis}`;
  const cached = getCachedResult(cacheKey);
  if (cached) return cached;

  const notes = patient.progressNotes.map(n => `- ${new Date(n.date).toLocaleString()}: ${n.note}`).join('\n');

  const prompt = `Analyze the following patient data and provide clinical insights.
Focus on potential complications to watch for, suggested immediate actions, and key physiological parameters to monitor.
Be concise and action-oriented.

Patient Unit: ${patient.unit}
Age: ${patient.age} ${patient.ageUnit}
Diagnosis: ${patient.diagnosis}
History: ${notes || 'No recent notes.'}

Output format:
**Potential Complications**: [List]
**Care Suggestions**: [List]
**Monitoring Priorities**: [List]`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT);
    const finalResult = result + AI_DISCLAIMER;
    setCachedResult(cacheKey, finalResult);
    return finalResult;
  } catch (error) {
    console.error("OpenAI Error:", error);
    return "Unable to generate insights at this time.";
  }
};

export const predictRisk = async (patient: Patient): Promise<{ riskLevel: 'Low' | 'Medium' | 'High'; justification: string }> => {
  const cacheKey = `risk-${patient.id}-${patient.diagnosis}-${patient.outcome}`;
  const cached = getCachedResult(cacheKey);
  if (cached) return cached;

  const prompt = `Evaluate the clinical risk level for this patient based on the diagnosis and age.
Patient: ${patient.age} ${patient.ageUnit}, Diagnosis: ${patient.diagnosis}, Unit: ${patient.unit}.

Output strictly in JSON format:
{ "riskLevel": "Low" | "Medium" | "High", "justification": "One sentence explanation" }`;

  try {
    const response = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT, { jsonMode: true });
    const text = response.replace(/```json|```/g, '').trim();
    const result = JSON.parse(text);
    setCachedResult(cacheKey, result);
    return result;
  } catch (error) {
    console.error("OpenAI Error:", error);
    return { riskLevel: 'Medium', justification: "AI risk assessment unavailable." };
  }
};

// ============================================================================
// CLINICAL DECISION SUPPORT
// ============================================================================

export const generateDifferentialDiagnosis = async (
  symptoms: string,
  age: number,
  ageUnit: string,
  unit: string
): Promise<string> => {
  const cacheKey = `diff-diag-${symptoms}-${age}-${ageUnit}-${unit}`;
  const cached = getCachedResult(cacheKey);
  if (cached) return cached;

  const prompt = `You are an expert ${unit} physician.
Generate a differential diagnosis list for a patient with the following presentation:

Age: ${age} ${ageUnit}
Unit: ${unit}
Symptoms/Presentation: ${symptoms}

Provide a ranked list (most likely first) of 5-7 possible diagnoses with:
- Diagnosis name
- Brief rationale (1-2 sentences)
- Probability category (High/Moderate/Low)

Format as a clear, numbered list.`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT);
    const finalResult = result + AI_DISCLAIMER;
    setCachedResult(cacheKey, finalResult);
    return finalResult;
  } catch (error) {
    console.error("Error generating differential diagnosis:", error);
    return "Unable to generate differential diagnosis at this time.";
  }
};

export const recommendTreatmentProtocol = async (
  diagnosis: string,
  age: number,
  ageUnit: string,
  comorbidities?: string
): Promise<string> => {
  const cacheKey = `treatment-${diagnosis}-${age}-${ageUnit}`;
  const cached = getCachedResult(cacheKey);
  if (cached) return cached;

  const prompt = `Provide evidence-based treatment recommendations for:

Diagnosis: ${diagnosis}
Patient Age: ${age} ${ageUnit}
${comorbidities ? `Comorbidities: ${comorbidities}` : ''}

Include:
1. Initial management steps
2. Medication recommendations (with age-appropriate dosing considerations)
3. Monitoring parameters
4. When to escalate care
5. Expected course and milestones

Be specific but concise. Reference evidence-based guidelines when applicable.`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT);
    const finalResult = result + AI_DISCLAIMER;
    setCachedResult(cacheKey, finalResult);
    return finalResult;
  } catch (error) {
    console.error("Error generating treatment protocol:", error);
    return "Unable to generate treatment protocol at this time.";
  }
};

export const checkDrugInteractions = async (
  medications: string[],
  conditions: string[]
): Promise<string> => {
  const cacheKey = `drug-check-${medications.join(',')}-${conditions.join(',')}`;
  const cached = getCachedResult(cacheKey);
  if (cached) return cached;

  const prompt = `You are a clinical pharmacist specializing in pediatric intensive care.
Check for drug interactions and contraindications:

Medications: ${medications.join(', ')}
Patient Conditions: ${conditions.join(', ')}

Provide:
1. Major drug-drug interactions (if any)
2. Drug-disease contraindications (if any)
3. Dosing considerations for pediatric patients
4. Monitoring recommendations

If no significant interactions, state "No major interactions detected."
Format as clear bullet points with severity ratings (Critical/Moderate/Minor).`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT);
    const finalResult = result + AI_DISCLAIMER;
    setCachedResult(cacheKey, finalResult);
    return finalResult;
  } catch (error) {
    console.error("Error checking drug interactions:", error);
    return "Unable to check drug interactions at this time.";
  }
};

export const calculateMedicationDosage = async (
  medication: string,
  weight: number,
  age: number,
  ageUnit: string,
  indication: string
): Promise<string> => {
  const prompt = `You are a pediatric pharmacist.
Calculate appropriate dosing for:

Medication: ${medication}
Patient Weight: ${weight} kg
Patient Age: ${age} ${ageUnit}
Indication: ${indication}

Provide:
1. Recommended dose (mg/kg or total dose)
2. Frequency
3. Route of administration
4. Maximum dose limits
5. Key monitoring parameters

Base recommendations on pediatric dosing guidelines.
If weight-based dosing, show the calculation.`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT);
    return result + AI_DISCLAIMER;
  } catch (error) {
    console.error("Error calculating medication dosage:", error);
    return "Unable to calculate medication dosage at this time.";
  }
};

// ============================================================================
// PREDICTIVE ANALYTICS
// ============================================================================

export const detectClinicalDeterioration = async (patient: Patient): Promise<string> => {
  const notes = patient.progressNotes
    .slice(-5)
    .map(n => `${new Date(n.date).toLocaleString()}: ${n.note}`)
    .join('\n');

  const prompt = `You are an expert in pediatric early warning systems.
Analyze the following patient's recent clinical trajectory:

Patient: ${patient.age} ${patient.ageUnit}, ${patient.unit}
Diagnosis: ${patient.diagnosis}
Recent Progress Notes:
${notes}

Assess for signs of clinical deterioration:
1. Calculate an estimated Early Warning Score (0-10 scale)
2. Identify concerning trends
3. Recommend immediate actions if deterioration detected
4. Suggest intensified monitoring parameters

Format: Score, Assessment, Recommendations`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT);
    return result + AI_DISCLAIMER;
  } catch (error) {
    console.error("Error detecting deterioration:", error);
    return "Unable to assess clinical deterioration at this time.";
  }
};

export const predictLengthOfStay = async (patient: Patient): Promise<string> => {
  const prompt = `You are an expert in hospital capacity planning and clinical outcomes.
Estimate the expected length of stay for:

Patient: ${patient.age} ${patient.ageUnit}
Unit: ${patient.unit}
Diagnosis: ${patient.diagnosis}
Current Status: ${patient.outcome}
Days since admission: ${Math.floor((Date.now() - new Date(patient.admissionDate).getTime()) / (1000 * 60 * 60 * 24))}

Provide:
1. Estimated remaining days (range)
2. Key milestones for discharge
3. Factors that could extend stay
4. Discharge planning recommendations`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT);
    return result + AI_DISCLAIMER;
  } catch (error) {
    console.error("Error predicting length of stay:", error);
    return "Unable to predict length of stay at this time.";
  }
};

export const assessStepDownReadiness = async (patient: Patient): Promise<string> => {
  const recentNotes = patient.progressNotes
    .slice(-3)
    .map(n => `${new Date(n.date).toLocaleString()}: ${n.note}`)
    .join('\n');

  const prompt = `You are an expert in pediatric step-down criteria.
Assess if this patient is ready for step-down from intensive care:

Patient: ${patient.age} ${patient.ageUnit}
Unit: ${patient.unit}
Diagnosis: ${patient.diagnosis}
Recent Notes:
${recentNotes}

Evaluate:
1. Hemodynamic stability
2. Respiratory status
3. Neurological status
4. Need for intensive monitoring
5. Risk of rapid deterioration

Provide: Ready/Not Ready recommendation with detailed justification.`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT);
    return result + AI_DISCLAIMER;
  } catch (error) {
    console.error("Error assessing step-down readiness:", error);
    return "Unable to assess step-down readiness at this time.";
  }
};

export const predictReadmissionRisk = async (patient: Patient): Promise<string> => {
  const prompt = `You are an expert in pediatric hospital readmissions.
Assess the 30-day readmission risk for:

Patient: ${patient.age} ${patient.ageUnit}
Diagnosis: ${patient.diagnosis}
Unit: ${patient.unit}
Current Outcome: ${patient.outcome}

Analyze:
1. Disease-specific risk factors
2. Social/environmental factors
3. Discharge readiness
4. Follow-up care adequacy

Provide: Risk Level (Low/Medium/High) with specific mitigation strategies.`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT);
    return result + AI_DISCLAIMER;
  } catch (error) {
    console.error("Error predicting readmission risk:", error);
    return "Unable to predict readmission risk at this time.";
  }
};

export const calculateSepsisRisk = async (patient: Patient, vitalSigns?: string): Promise<string> => {
  const prompt = `You are an expert in pediatric sepsis recognition.
Calculate sepsis risk for:

Patient: ${patient.age} ${patient.ageUnit}
Diagnosis: ${patient.diagnosis}
${vitalSigns ? `Recent Vitals: ${vitalSigns}` : ''}

Assess for:
1. Sepsis risk score (Low/Moderate/High/Critical)
2. SIRS criteria met
3. End-organ dysfunction signs
4. Recommended interventions
5. Timing of reassessment

Provide immediate actionable guidance if high risk detected.`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT);
    return result + "\n\n⚠️ CRITICAL: Sepsis is a medical emergency. This AI assessment does not replace clinical judgment. Escalate immediately if concerned.";
  } catch (error) {
    console.error("Error calculating sepsis risk:", error);
    return "Unable to calculate sepsis risk at this time.";
  }
};

export const generateEarlyWarningScore = async (patient: Patient): Promise<string> => {
  const recentNote = patient.progressNotes[patient.progressNotes.length - 1];

  const prompt = `You are an expert in Pediatric Early Warning Scores (PEWS).
Calculate an estimated PEWS for:

Patient: ${patient.age} ${patient.ageUnit}
Unit: ${patient.unit}
Diagnosis: ${patient.diagnosis}
Most Recent Note: ${recentNote ? recentNote.note : 'No recent notes'}

Provide:
1. Estimated PEWS score (0-9+ scale)
2. Score breakdown by category (Behavior, Cardiovascular, Respiratory)
3. Interpretation and risk level
4. Recommended actions based on score

Note: This is an estimation based on documentation. Actual PEWS requires vital signs.`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT);
    return result + AI_DISCLAIMER;
  } catch (error) {
    console.error("Error generating early warning score:", error);
    return "Unable to generate early warning score at this time.";
  }
};

// ============================================================================
// DOCUMENTATION AI
// ============================================================================

export const generateHandoffNote = async (patient: Patient, shiftType: 'day' | 'night'): Promise<string> => {
  const notes = patient.progressNotes.slice(-3).map(n => `${new Date(n.date).toLocaleString()}: ${n.note}`).join('\n');

  const prompt = `Generate a ${shiftType} shift handoff note in SBAR format.

Patient: ${patient.name} (${patient.age} ${patient.ageUnit})
Unit: ${patient.unit}
Diagnosis: ${patient.diagnosis}
Current Status: ${patient.outcome}
Recent Events:
${notes}

Generate a concise SBAR handoff:
**Situation**: One-line patient summary
**Background**: Key history and diagnosis
**Assessment**: Current clinical status and trends
**Recommendation**: Key actions needed in next 12 hours

Be specific about time-sensitive tasks and concerns.`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT);
    return result;
  } catch (error) {
    console.error("Error generating handoff note:", error);
    return "Unable to generate handoff note at this time.";
  }
};

export const generateRoundingSheet = async (patients: Patient[], unit: string): Promise<string> => {
  const patientSummaries = patients
    .filter(p => p.outcome === 'In Progress')
    .map(p => `- ${p.name} (${p.age} ${p.ageUnit}): ${p.diagnosis}`)
    .join('\n');

  const prompt = `Prepare a rounds sheet for the ${unit} team.

Active Patients:
${patientSummaries}

Create a prioritized rounding list with:
1. Highest priority patients first (most unstable/complex)
2. Brief one-liner for each patient
3. Key decision points for today
4. Estimated time per patient

Format as a numbered list ready for morning rounds.`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT);
    return result;
  } catch (error) {
    console.error("Error generating rounding sheet:", error);
    return "Unable to generate rounding sheet at this time.";
  }
};

export const structureProgressNote = async (rawText: string): Promise<string> => {
  const prompt = `Convert this raw clinical note into structured SOAP format:

Raw Note:
${rawText}

Output format:
**Subjective**: Patient/family concerns and symptoms
**Objective**: Clinical findings, vitals, labs
**Assessment**: Clinical interpretation and diagnosis
**Plan**: Treatment plan and follow-up

Clean up grammar and medical terminology. Keep it concise.`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT);
    return result;
  } catch (error) {
    console.error("Error structuring progress note:", error);
    return "Unable to structure progress note at this time.";
  }
};

export const extractPatientInfoFromText = async (text: string): Promise<any> => {
  const prompt = `Extract structured patient information from this clinical text:

${text}

Extract and output as JSON:
{
  "name": "patient name if mentioned",
  "age": number,
  "ageUnit": "days/weeks/months/years",
  "gender": "Male/Female",
  "diagnosis": "primary diagnosis",
  "symptoms": "key symptoms or presentation",
  "history": "relevant history"
}

If information is not present, use null. Output only valid JSON.`;

  try {
    const response = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT, { jsonMode: true });
    const cleaned = response.replace(/```json|```/g, '').trim();
    return JSON.parse(cleaned);
  } catch (error) {
    console.error("Error extracting patient info:", error);
    return null;
  }
};

// ============================================================================
// REPORTING & ANALYTICS
// ============================================================================

export const generateMonthlyReport = async (
  patients: Patient[],
  month: string,
  unit: string,
  institutionName: string
): Promise<string> => {
  const stats = {
    total: patients.length,
    discharged: patients.filter(p => p.outcome === 'Discharged').length,
    deceased: patients.filter(p => p.outcome === 'Deceased').length,
    referred: patients.filter(p => p.outcome === 'Referred').length,
    inProgress: patients.filter(p => p.outcome === 'In Progress').length,
  };

  const prompt = `Generate a comprehensive monthly report for:

Institution: ${institutionName}
Unit: ${unit}
Month: ${month}

Statistics:
- Total Admissions: ${stats.total}
- Discharged: ${stats.discharged}
- Deceased: ${stats.deceased}
- Referred: ${stats.referred}
- Currently Admitted: ${stats.inProgress}

Include:
1. Executive Summary
2. Key Performance Metrics
3. Outcome Analysis
4. Mortality Review Summary
5. Recommendations for Quality Improvement

Format as a professional report suitable for hospital administration.`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT, { maxTokens: 3000 });
    return result;
  } catch (error) {
    console.error("Error generating monthly report:", error);
    return "Unable to generate monthly report at this time.";
  }
};

export const generateDischargeInstructions = async (patient: Patient): Promise<string> => {
  const prompt = `Generate family-friendly discharge instructions for:

Patient: ${patient.age} ${patient.ageUnit} old child
Diagnosis: ${patient.diagnosis}

Include:
1. **Home Care Instructions** (in simple language)
2. **Medications** (if applicable, general categories)
3. **Warning Signs** to watch for (when to seek emergency care)
4. **Follow-up Care** recommendations
5. **Activity Restrictions** (if any)
6. **Feeding/Nutrition** guidance

Use clear, non-medical language that families can understand.
Format with bullet points for easy reading.`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT);
    return result;
  } catch (error) {
    console.error("Error generating discharge instructions:", error);
    return "Unable to generate discharge instructions at this time.";
  }
};

export const generateMortalityReview = async (deceasedPatients: Patient[]): Promise<string> => {
  const patientSummaries = deceasedPatients.map(p =>
    `- ${p.age} ${p.ageUnit}, Diagnosis: ${p.diagnosis}`
  ).join('\n');

  const prompt = `Generate a Morbidity & Mortality (M&M) review summary for:

Deceased Patients:
${patientSummaries}

Analyze:
1. Common diagnoses leading to mortality
2. Age distribution analysis
3. Potential preventable factors (general patterns)
4. Quality improvement opportunities
5. System-level recommendations

Format as a structured M&M report suitable for clinical review.
Be respectful and focus on learning opportunities.`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT, { maxTokens: 3000 });
    return result;
  } catch (error) {
    console.error("Error generating mortality review:", error);
    return "Unable to generate mortality review at this time.";
  }
};

export const auditClinicalDocumentation = async (patient: Patient): Promise<string> => {
  const prompt = `Audit the clinical documentation completeness for:

Patient: ${patient.age} ${patient.ageUnit}
Diagnosis: ${patient.diagnosis}
Progress Notes: ${patient.progressNotes.length} notes
Outcome: ${patient.outcome}

Check for:
1. Documentation completeness
2. Missing critical information
3. Billing/coding opportunities
4. Quality metric compliance
5. Recommendations for improved documentation

Provide actionable feedback for the clinical team.`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT);
    return result;
  } catch (error) {
    console.error("Error auditing documentation:", error);
    return "Unable to audit documentation at this time.";
  }
};

// ============================================================================
// SEARCH & INTELLIGENCE
// ============================================================================

export const findSimilarPatients = async (
  patient: Patient,
  allPatients: Patient[]
): Promise<string> => {
  const otherPatients = allPatients
    .filter(p => p.id !== patient.id)
    .slice(0, 50)
    .map(p => `${p.age} ${p.ageUnit}, Diagnosis: ${p.diagnosis}, Outcome: ${p.outcome}`)
    .join('\n');

  const prompt = `Find patients similar to:
Index Patient: ${patient.age} ${patient.ageUnit}, Diagnosis: ${patient.diagnosis}

From this dataset:
${otherPatients}

Identify the 5 most similar patients based on:
- Age similarity
- Diagnosis similarity
- Clinical complexity

For each similar patient, explain why they're relevant and what can be learned from their outcome.`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT);
    return result;
  } catch (error) {
    console.error("Error finding similar patients:", error);
    return "Unable to find similar patients at this time.";
  }
};

// ============================================================================
// EDUCATIONAL SUPPORT
// ============================================================================

export const explainDiagnosis = async (
  diagnosis: string,
  audience: 'doctor' | 'nurse' | 'family'
): Promise<string> => {
  const audienceContext = {
    doctor: "another physician - include pathophysiology and evidence-based management",
    nurse: "nursing staff - focus on care protocols and monitoring",
    family: "patient's family in simple, non-medical language"
  };

  const prompt = `Explain "${diagnosis}" to ${audienceContext[audience]}.

Include:
${audience === 'family' ? '1. What it is in simple terms\n2. What causes it\n3. How it\'s treated\n4. What to expect\n5. When to worry' : '1. Clinical overview\n2. Key features\n3. Management approach\n4. Monitoring priorities\n5. Complications to watch for'}

Keep it ${audience === 'family' ? 'reassuring but honest' : 'clinically focused and evidence-based'}.`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT);
    return result;
  } catch (error) {
    console.error("Error explaining diagnosis:", error);
    return "Unable to explain diagnosis at this time.";
  }
};

export const suggestClinicalGuidelines = async (diagnosis: string): Promise<string> => {
  const prompt = `Provide evidence-based clinical guidelines for: ${diagnosis}

Include:
1. Relevant AAP (American Academy of Pediatrics) guidelines
2. WHO recommendations (if applicable)
3. Key evidence-based practices
4. Quality metrics for this condition
5. References to major clinical trials or guidelines

Format as a quick reference guide.`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT);
    return result + AI_DISCLAIMER;
  } catch (error) {
    console.error("Error suggesting guidelines:", error);
    return "Unable to suggest clinical guidelines at this time.";
  }
};

export const answerClinicalQuestion = async (
  question: string,
  patientContext?: Patient
): Promise<string> => {
  const context = patientContext
    ? `\n\nPatient Context: ${patientContext.age} ${patientContext.ageUnit}, ${patientContext.diagnosis}, ${patientContext.unit}`
    : '';

  const prompt = `Answer this clinical question: ${question}
${context}

Provide:
1. Direct answer
2. Evidence basis (if applicable)
3. Practical clinical pearls
4. When to seek specialist consultation

Be concise but thorough.`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT);
    return result + AI_DISCLAIMER;
  } catch (error) {
    console.error("Error answering clinical question:", error);
    return "Unable to answer clinical question at this time.";
  }
};

// ============================================================================
// DATA VALIDATION
// ============================================================================

export const validatePatientData = async (formData: Partial<Patient>): Promise<string> => {
  const prompt = `Validate this patient data for clinical consistency:

Age: ${formData.age} ${formData.ageUnit}
Diagnosis: ${formData.diagnosis}
Unit: ${formData.unit}

Check for:
1. Age-appropriate diagnosis
2. Appropriate unit assignment
3. Missing critical information
4. Unusual or concerning combinations

Provide: "Valid" or list specific concerns with recommendations.`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT, { model: OPENAI_MODEL_FAST });
    return result;
  } catch (error) {
    console.error("Error validating patient data:", error);
    return "Unable to validate patient data at this time.";
  }
};

export const suggestDiagnosis = async (
  partialInput: string,
  age?: number,
  ageUnit?: string,
  unit?: string
): Promise<string[]> => {
  const context = age && ageUnit && unit
    ? `for a ${age} ${ageUnit} old patient in ${unit}`
    : '';

  const prompt = `Suggest diagnoses that match "${partialInput}" ${context}.

Return 5-7 most relevant diagnoses as a simple comma-separated list.
Use standard medical terminology.
Only return the diagnosis names, nothing else.`;

  try {
    const response = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT, { model: OPENAI_MODEL_FAST });
    const suggestions = response
      .split(',')
      .map(s => s.trim())
      .filter(s => s.length > 0)
      .slice(0, 7);
    return suggestions;
  } catch (error) {
    console.error("Error suggesting diagnoses:", error);
    return [];
  }
};

// ============================================================================
// CHART ANALYTICS AI
// ============================================================================

export const explainChartData = async (
  chartTitle: string,
  chartType: string,
  dataPoints: { label: string; value: number | string }[],
  context?: string
): Promise<string> => {
  const dataString = dataPoints
    .map(d => `${d.label}: ${d.value}`)
    .join('\n');

  const cacheKey = `chart-explain-${chartTitle}-${JSON.stringify(dataPoints).slice(0, 100)}`;
  const cached = getCachedResult(cacheKey);
  if (cached) return cached;

  const prompt = `Analyze this ${chartType} chart data and provide clinically relevant insights.

Chart Title: ${chartTitle}
${context ? `Context: ${context}` : ''}

Data:
${dataString}

Provide a concise analysis including:
1. **Key Insights** - What does this data tell us? (2-3 bullet points)
2. **Trends** - Any notable patterns or trends
3. **Clinical Implications** - What should clinicians pay attention to?
4. **Recommendations** - Any actionable suggestions

Keep the response concise (under 200 words) and clinically focused.
Use simple bullet points. Be specific to the numbers shown.`;

  try {
    const result = await callOpenAI(
      prompt,
      'You are NeolinkAI, an expert healthcare analytics assistant for NICU/PICU. Provide concise, clinically relevant insights. Do not use markdown formatting.'
    );
    const finalResult = result + AI_DISCLAIMER;
    setCachedResult(cacheKey, finalResult);
    console.log("✅ Chart explanation generated using OpenAI GPT-5.2");
    return finalResult;
  } catch (error) {
    console.error("Error explaining chart data:", error);
    return "Unable to generate chart explanation at this time. Please try again.";
  }
};

// ============================================================================
// DEATH DIAGNOSIS INTERPRETATION
// ============================================================================

export const interpretDeathDiagnosis = async (
  fullDiagnosis: string,
  patientAge: number,
  patientAgeUnit: string,
  unit: string
): Promise<string> => {
  const cacheKey = `death-diagnosis-${fullDiagnosis.slice(0, 50)}`;
  const cached = getCachedResult(cacheKey);
  if (cached) return cached;

  const prompt = `You are an expert medical analyst specializing in mortality documentation for NICU/PICU.

Analyze this detailed death diagnosis and provide a concise, structured summary for clinical analytics and mortality reporting.

Patient: ${patientAge} ${patientAgeUnit} old
Unit: ${unit}

Full Diagnosis at Time of Death:
${fullDiagnosis}

Generate a concise, professional summary (2-3 sentences maximum) that includes:
1. Primary cause of death (most important)
2. Key contributing factors
3. Brief clinical context if relevant

Requirements:
- Use standard medical terminology
- Be objective and factual
- Focus on causation, not description
- Maximum 3 sentences
- Suitable for mortality analytics and review

Output ONLY the concise diagnosis summary, nothing else.`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT);
    const trimmedResult = result.trim();
    setCachedResult(cacheKey, trimmedResult);
    return trimmedResult;
  } catch (error) {
    console.error("Error interpreting death diagnosis:", error);
    return "Error: Unable to interpret diagnosis. The original diagnosis has been recorded.";
  }
};

export const analyzeDeathDiagnosisPatterns = async (
  deceasedPatients: Patient[]
): Promise<string> => {
  const diagnosisSummaries = deceasedPatients
    .filter(p => p.aiInterpretedDeathDiagnosis || p.diagnosisAtDeath)
    .slice(0, 50)
    .map(p => {
      const diagnosis = p.aiInterpretedDeathDiagnosis || p.diagnosisAtDeath || 'Unknown';
      const daysInUnit = p.dateOfDeath && p.admissionDate
        ? Math.ceil((new Date(p.dateOfDeath).getTime() - new Date(p.admissionDate).getTime()) / (1000 * 60 * 60 * 24))
        : 'unknown';
      return `- ${p.age} ${p.ageUnit}, ${p.unit}, ${daysInUnit} days in unit: ${diagnosis}`;
    })
    .join('\n');

  if (!diagnosisSummaries) {
    return "No death diagnosis data available for analysis.";
  }

  const prompt = `You are an expert pediatric intensivist and mortality review specialist with deep knowledge of NICU/PICU care patterns.

Analyze these death diagnoses from NICU/PICU patients and provide a comprehensive, actionable analysis.

Death Diagnosis Data (${deceasedPatients.length} deceased patients):
${diagnosisSummaries}

Provide a detailed, evidence-based analysis with the following structure:

## EXECUTIVE SUMMARY
- 2-3 sentence overview of key findings
- Most critical insight requiring immediate attention

## PRIMARY CAUSES OF DEATH
Rank the top 5-7 causes with:
- Specific diagnosis/condition
- Estimated percentage (%)
- Typical age group affected
- Common time to death (early vs late mortality)

## AGE-STRATIFIED ANALYSIS
Break down by age groups:
- **Neonates (0-28 days)**: Common causes, patterns
- **Infants (1-12 months)**: Common causes, patterns
- **Children (>1 year)**: Common causes, patterns

## UNIT-SPECIFIC PATTERNS
- **NICU mortality**: Dominant conditions, preventability assessment
- **PICU mortality**: Dominant conditions, preventability assessment
- Comparison and contrasts between units

## TEMPORAL PATTERNS
- Early deaths (<24 hours): What's driving these?
- Late deaths (>7 days): What conditions lead to prolonged ICU stays before death?
- Identify any critical windows

## POTENTIALLY PREVENTABLE DEATHS
- Which cases might have been preventable with earlier intervention?
- What specific gaps in care are suggested?
- Are there recurring themes?

## CLINICAL INSIGHTS
- Pathophysiology patterns across cases
- Co-morbidities contributing to mortality
- Treatment challenges identified

## QUALITY IMPROVEMENT RECOMMENDATIONS
Provide 5-7 specific, actionable recommendations:
1. **Protocol Changes**: What clinical protocols should be revised?
2. **Early Warning Systems**: What monitoring could catch deterioration earlier?
3. **Resource Allocation**: Where should resources be focused?
4. **Staff Training**: What specific competencies need strengthening?
5. **Equipment/Technology**: What could help prevent these deaths?
6. **Family Counseling**: How to better support families?
7. **Research Opportunities**: What needs further investigation?

## LEARNING POINTS
- Key clinical pearls from this data
- What should the team prioritize?

## SUCCESS METRICS
- How should improvements be measured?
- What KPIs should be tracked?

Use specific numbers from the data. Be direct, evidence-based, and actionable. Format with clear headers, bullet points, and bold text for emphasis.`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT, { maxTokens: 4000 });
    return result + "\n\n" + AI_DISCLAIMER;
  } catch (error) {
    console.error("Error analyzing death diagnosis patterns:", error);
    return "Unable to analyze death diagnosis patterns at this time.";
  }
};

/**
 * Analyze individual patient mortality
 */
export const analyzeIndividualMortality = async (patient: Patient): Promise<string> => {
  const daysInUnit = patient.dateOfDeath && patient.admissionDate
    ? Math.ceil((new Date(patient.dateOfDeath).getTime() - new Date(patient.admissionDate).getTime()) / (1000 * 60 * 60 * 24))
    : 'unknown';

  const recentNotes = patient.progressNotes
    .slice(-5)
    .map(n => `${new Date(n.date).toLocaleString()}: ${n.note || 'No note'}`)
    .join('\n');

  const prompt = `You are a pediatric mortality review specialist. Provide a concise clinical analysis.

**Patient Details:**
- Age: ${patient.age} ${patient.ageUnit}
- Unit: ${patient.unit}
- Days in unit: ${daysInUnit}
- Admission: ${new Date(patient.admissionDate).toLocaleDateString()}
- Death: ${patient.dateOfDeath ? `${new Date(patient.dateOfDeath).toLocaleDateString()} at ${new Date(patient.dateOfDeath).toLocaleTimeString()}` : 'Not recorded'}

**Diagnosis at Death:**
${patient.diagnosisAtDeath || 'Not recorded'}

**Recent Clinical Notes:**
${recentNotes || 'No notes available'}

Provide a brief clinical summary (3-4 concise paragraphs):

**Clinical Summary:**
Briefly describe the patient's presentation, clinical course, and cause of death.

**Key Findings:**
- Primary cause of death
- Contributing factors
- Critical events in the timeline

**Assessment:**
Brief note on preventability (Preventable/Potentially Preventable/Non-Preventable) with 1-2 sentence justification.

Keep the response professional, concise, and under 200 words total. No separate detailed sections needed.`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT);
    return result + "\n\n" + AI_DISCLAIMER;
  } catch (error) {
    console.error("Error analyzing individual mortality:", error);
    return "Unable to analyze individual mortality at this time.";
  }
};

// ============================================================================
// VOICE & CLINICAL NOTE AI
// ============================================================================

export const formatVoiceTranscript = async (
  transcript: string,
  noteType: 'progress' | 'admission' | 'discharge'
): Promise<string> => {
  const formatGuide = {
    progress: 'SOAP format (Subjective, Objective, Assessment, Plan)',
    admission: 'Admission note format (Chief Complaint, History, Examination, Plan)',
    discharge: 'Discharge summary format (Hospital Course, Diagnosis, Instructions, Follow-up)'
  };

  const prompt = `Convert this voice-dictated clinical note into a structured ${noteType} note.

Voice Transcript:
${transcript}

Format as: ${formatGuide[noteType]}

Clean up:
- Fix grammar and punctuation
- Expand medical abbreviations where helpful
- Organize information logically
- Keep clinical content accurate
- Remove filler words

Output the formatted clinical note only.`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT);
    return result;
  } catch (error) {
    console.error("Error formatting voice transcript:", error);
    return transcript; // Return original if formatting fails
  }
};

export const extractMedicationsFromNote = async (note: string): Promise<any[]> => {
  const prompt = `Extract all medications mentioned in this clinical note:

${note}

For each medication found, extract:
- name: medication name
- dose: dosage if mentioned
- route: route of administration if mentioned
- frequency: frequency if mentioned

Output as JSON array:
[{ "name": "...", "dose": "...", "route": "...", "frequency": "..." }]

If no medications found, return empty array: []`;

  try {
    const response = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT, { jsonMode: true });
    const cleaned = response.replace(/```json|```/g, '').trim();
    return JSON.parse(cleaned);
  } catch (error) {
    console.error("Error extracting medications:", error);
    return [];
  }
};

export const generateClinicalNoteFromTemplate = async (
  template: string,
  patientData: any,
  additionalContext?: string
): Promise<string> => {
  const prompt = `Generate a clinical note based on this template and patient data.

Template:
${template}

Patient Data:
${JSON.stringify(patientData, null, 2)}

${additionalContext ? `Additional Context: ${additionalContext}` : ''}

Fill in the template with appropriate clinical content based on the patient data.
Maintain professional medical documentation standards.
Keep responses concise and clinically relevant.`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT);
    return result;
  } catch (error) {
    console.error("Error generating clinical note:", error);
    return "Unable to generate clinical note at this time.";
  }
};

// ============================================================================
// DISCHARGE SUMMARY GENERATION
// ============================================================================

/**
 * Generate a comprehensive clinical course summary for discharge
 */
export const generateDischargeClinicalSummary = async (patient: Patient): Promise<string> => {
  const progressNotes = patient.progressNotes || [];

  // Format progress notes for AI
  const notesText = progressNotes.map((note, index) => {
    const date = new Date(note.date).toLocaleDateString('en-IN', {
      day: '2-digit', month: 'short', year: 'numeric'
    });

    let noteContent = `Day ${index + 1} (${date}):`;

    if (note.note) {
      noteContent += ` ${note.note}`;
    }

    if (note.vitals) {
      const vitals = Object.entries(note.vitals)
        .filter(([_, v]) => v)
        .map(([k, v]) => `${k}: ${v}`)
        .join(', ');
      if (vitals) noteContent += ` Vitals: ${vitals}.`;
    }

    if (note.examination) {
      const exam = Object.entries(note.examination)
        .filter(([_, v]) => v)
        .map(([k, v]) => `${k}: ${v}`)
        .join(', ');
      if (exam) noteContent += ` Examination: ${exam}.`;
    }

    if (note.medications && note.medications.length > 0) {
      const meds = note.medications.map(m => `${m.name} ${m.dose}`).join(', ');
      noteContent += ` Medications: ${meds}.`;
    }

    return noteContent;
  }).join('\n');

  // Calculate length of stay
  const admissionDate = new Date(patient.admissionDate);
  const dischargeDate = patient.releaseDate ? new Date(patient.releaseDate) : new Date();
  const stayDays = Math.ceil((dischargeDate.getTime() - admissionDate.getTime()) / (1000 * 60 * 60 * 24));

  const prompt = `You are a senior neonatologist/pediatric intensivist writing a discharge summary. Generate a comprehensive but concise CLINICAL COURSE SUMMARY based on the patient data below.

=== PATIENT INFORMATION ===
Name: ${patient.name}
Age: ${patient.age} ${patient.ageUnit}
Gender: ${patient.gender}
Unit: ${patient.unit}
Admission Date: ${new Date(patient.admissionDate).toLocaleDateString('en-IN')}
Length of Stay: ${stayDays} days
Primary Diagnosis: ${patient.diagnosis}
${patient.birthWeight ? `Birth Weight: ${patient.birthWeight} kg` : ''}
${patient.gestationalAgeWeeks ? `Gestational Age: ${patient.gestationalAgeWeeks} weeks ${patient.gestationalAgeDays || 0} days (${patient.gestationalAgeCategory || ''})` : ''}
${patient.modeOfDelivery ? `Mode of Delivery: ${patient.modeOfDelivery}` : ''}
${patient.indicationsForAdmission?.length ? `Indications for Admission: ${patient.indicationsForAdmission.join(', ')}` : ''}

=== MATERNAL HISTORY ===
${patient.maternalHistory ? `
Mother's Age: ${patient.maternalHistory.maternalAge || 'Unknown'}
Obstetric History: G${patient.maternalHistory.gravida || 0} P${patient.maternalHistory.para || 0} A${patient.maternalHistory.abortion || 0} L${patient.maternalHistory.living || 0}
ANC: ${patient.maternalHistory.ancReceived ? 'Yes' : 'No'}${patient.maternalHistory.ancVisits ? ` (${patient.maternalHistory.ancVisits} visits)` : ''}
Antenatal Steroids: ${patient.maternalHistory.antenatalSteroidsGiven ? 'Yes' : 'No'}
Risk Factors: ${patient.maternalHistory.riskFactors?.join(', ') || 'None documented'}
` : 'Not documented'}

=== PROGRESS NOTES ===
${notesText || 'No detailed progress notes available.'}

=== CURRENT MEDICATIONS ===
${(patient.medications || []).filter(m => m.isActive !== false).map(m => `- ${m.name} ${m.dose} ${m.route || ''} ${m.frequency || ''}`).join('\n') || 'None'}

=== WRITE CLINICAL COURSE ===
Write as the TREATING DOCTOR documenting the hospital stay. Use proper medical documentation style.

FORMAT EXAMPLE:
"Baby was admitted with respiratory distress syndrome. On admission, baby had tachypnea and subcostal retractions. During hospital stay, baby received intravenous fluids, antibiotics, and surfactant therapy. Respiratory support was gradually weaned from CPAP to room air. Baby showed good clinical improvement. Currently baby is stable, accepting direct breastfeeds, maintaining oxygen saturation on room air, and is fit for discharge."

RULES:
1. Use "Baby was..." or "Child was..." - NOT "The patient" or "He/She"
2. Write in PASSIVE VOICE - proper medical documentation style
3. Be CONCISE - 4-5 sentences maximum, 80-120 words
4. Write FULL TERMS - "room air" not "RA", "antibiotics" not "Abx", "intravenous" not "IV"
5. ONLY mention documented treatments and findings
6. NO speculation or unconfirmed diagnoses
7. End with current stable status and discharge readiness
8. NO markdown, bullets, or formatting - plain text only
9. Write professionally and clearly - this is an official medical document`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT, {
      temperature: 0.4,
      maxTokens: 800
    });
    return result;
  } catch (error) {
    console.error('Error generating discharge clinical summary:', error);
    return 'Clinical course summary could not be generated. Please enter manually.';
  }
};

/**
 * Generate discharge advice based on patient condition and diagnoses
 */
export const generateDischargeAdvice = async (
  patient: Patient,
  isNICU: boolean
): Promise<string[]> => {
  // Build detailed treatment context
  const activeMeds = (patient.medications || []).filter(m => m.isActive !== false);
  const medDetails = activeMeds.map(m => {
    let detail = m.name;
    if (m.dose) detail += ` ${m.dose}`;
    if (m.frequency) detail += ` ${m.frequency}`;
    return detail;
  }).join('; ') || 'None';

  // Get recent progress notes summary
  const recentNotes = (patient.progressNotes || []).slice(-3).map(n => n.note).join(' ');

  const prompt = `You are a senior pediatrician writing discharge advice. Generate EXACTLY 8 specific, clinically valuable advice points.

PATIENT DATA:
- Age: ${patient.age} ${patient.ageUnit}
- Unit: ${isNICU ? 'NICU/SNCU' : 'PICU'}
- Diagnosis: ${patient.diagnosis}
${patient.birthWeight ? `- Birth Weight: ${patient.birthWeight}g` : ''}
${patient.gestationalAgeCategory ? `- Gestational: ${patient.gestationalAgeCategory}` : ''}
${patient.currentWeight ? `- Current Weight: ${patient.currentWeight}g` : ''}
- Discharge Medications: ${medDetails}
${recentNotes ? `- Clinical Course: ${recentNotes.substring(0, 500)}` : ''}

REQUIREMENTS - Generate EXACTLY 8 advice points:

DIAGNOSIS-SPECIFIC (5 points):
1. Specific medication instruction with timing/food relation if relevant
2. Specific feeding advice based on diagnosis (volume, frequency, type, fortification if needed)
3. Specific activity/positioning advice for this condition
4. Specific symptom to monitor that indicates worsening of THIS diagnosis
5. Specific complication prevention for THIS diagnosis

GENERAL CARE (3 points):
6. Hygiene/infection prevention relevant to this patient
7. Growth monitoring specific to this patient's condition
8. Clear follow-up instruction with what to bring/expect

RULES:
- NO generic fluff like "follow doctor's advice" or "watch for warning signs"
- Include SPECIFIC numbers where applicable (temperature ranges, feeding volumes, time intervals)
- Each advice must be ACTIONABLE - parent should know exactly what to do
- Be CONCISE but COMPLETE - one clear instruction per point

Return ONLY a JSON array of exactly 8 strings. No explanations.`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT, {
      temperature: 0.4,
      maxTokens: 1000,
      jsonMode: true
    });

    const parsed = JSON.parse(result);
    let advice: string[] = [];
    if (Array.isArray(parsed)) advice = parsed;
    else if (parsed.advice && Array.isArray(parsed.advice)) advice = parsed.advice;
    else return getDefaultDischargeAdvice(isNICU, patient.diagnosis);

    // Ensure exactly 8 items
    if (advice.length > 8) advice = advice.slice(0, 8);
    while (advice.length < 8) {
      const defaults = getDefaultDischargeAdvice(isNICU, patient.diagnosis);
      advice.push(defaults[advice.length % defaults.length]);
    }
    return advice;
  } catch (error) {
    console.error('Error generating discharge advice:', error);
    return getDefaultDischargeAdvice(isNICU, patient.diagnosis);
  }
};

function getDefaultDischargeAdvice(isNICU: boolean, diagnosis?: string): string[] {
  if (isNICU) {
    return [
      `Give medications 30 minutes before feeds to ensure proper absorption`,
      `Feed ${diagnosis?.toLowerCase().includes('preterm') ? '8-10 times daily (every 2-3 hours), 30-60ml per feed based on weight' : 'on demand, ensuring at least 8 feeds in 24 hours'}`,
      `Position baby on back for sleep; elevate head end 15-30 degrees if reflux present`,
      `Monitor breathing pattern - count respirations; report if >60/min or chest indrawing`,
      `Maintain room temperature 25-28°C; dress baby in one layer more than adult`,
      `Wash hands with soap for 20 seconds before every handling; limit visitors for 2 weeks`,
      `Weigh baby weekly; expect 20-30g weight gain daily; report if no gain for 1 week`,
      `Follow-up on scheduled date; bring discharge summary and all medication bottles`
    ];
  } else {
    return [
      `Complete full antibiotic course even if child feels better; do not skip doses`,
      `Offer small frequent meals (6 times daily); avoid fried/spicy food for 1 week`,
      `Allow rest but encourage light activity; avoid strenuous play for ${diagnosis?.toLowerCase().includes('pneumonia') ? '2 weeks' : '1 week'}`,
      `Monitor temperature twice daily; report fever >38.5°C lasting >24 hours`,
      `Watch for ${diagnosis?.toLowerCase().includes('respiratory') ? 'fast breathing >40/min, inability to drink, excessive sleepiness' : 'persistent vomiting, severe abdominal pain, blood in stool'}`,
      `Ensure handwashing before meals; keep child away from sick contacts for 1 week`,
      `Monitor urine output - should pass urine at least 4-6 times daily; report if less`,
      `Follow-up in OPD on scheduled date; bring this discharge summary and pending reports`
    ];
  }
}

/**
 * Generate warning signs to watch based on diagnosis
 */
export const generateWarningSignsForDischarge = async (
  patient: Patient,
  isNICU: boolean
): Promise<string[]> => {
  const prompt = `Generate warning signs for parents/caregivers to watch after discharge.

Patient: ${patient.name}
Age: ${patient.age} ${patient.ageUnit}
Unit: ${isNICU ? 'NICU/SNCU (Neonatal)' : 'PICU (Pediatric)'}
Diagnosis: ${patient.diagnosis}
${patient.gestationalAgeCategory ? `Gestational Category: ${patient.gestationalAgeCategory}` : ''}

Generate 6-8 specific warning signs that should prompt immediate medical attention.
These should be tailored to the patient's diagnosis and age.

Format: Return ONLY a JSON array of strings.
Example: ["High fever (>100.4°F/38°C)", "Difficulty breathing", ...]

Return ONLY the JSON array.`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT, {
      temperature: 0.3,
      maxTokens: 400,
      jsonMode: true
    });

    const parsed = JSON.parse(result);
    if (Array.isArray(parsed)) return parsed;
    if (parsed.signs && Array.isArray(parsed.signs)) return parsed.signs;

    return getDefaultWarnings(isNICU);
  } catch (error) {
    console.error('Error generating warning signs:', error);
    return getDefaultWarnings(isNICU);
  }
};

function getDefaultWarnings(isNICU: boolean): string[] {
  if (isNICU) {
    return [
      'Difficulty breathing or fast breathing (>60/min)',
      'Not feeding well or refusing to feed',
      'High fever (>100.4°F / 38°C) or very cold baby',
      'Yellow discoloration of skin or eyes (jaundice)',
      'Excessive sleepiness or difficulty waking for feeds',
      'Convulsions or abnormal movements',
      'Umbilical cord redness, swelling, or foul discharge',
      'Skin rash, pustules, or blisters'
    ];
  } else {
    return [
      'High fever that does not respond to medication',
      'Difficulty breathing or rapid breathing',
      'Persistent vomiting or inability to keep fluids down',
      'Signs of dehydration (dry mouth, no tears, reduced urination)',
      'Unusual drowsiness or confusion',
      'Seizures or convulsions',
      'Severe abdominal pain',
      'Rash that does not fade with pressure'
    ];
  }
}

/**
 * Generate final diagnosis for discharge based on clinical course analysis
 * Uses accurate ICD-10 aligned medical terminology
 * Format: Concise, standard medical discharge diagnosis
 */
export const generateFinalDiagnosis = async (patient: Patient): Promise<string> => {
  const progressNotes = patient.progressNotes || [];

  // Format progress notes for AI (brief)
  const notesText = progressNotes.slice(-5).map((note, index) => {
    let content = `Day ${index + 1}:`;
    if (note.note) content += ` ${note.note.substring(0, 200)}`;
    return content;
  }).join(' | ');

  // Determine gestational age string with proper format
  let gaString = '';
  let pretermCategory = '';
  if (patient.gestationalAgeWeeks !== undefined) {
    const weeks = patient.gestationalAgeWeeks;
    const days = patient.gestationalAgeDays || 0;
    gaString = days > 0 ? `${weeks}+${days} weeks` : `${weeks} weeks`;

    if (weeks < 28) pretermCategory = 'Extreme preterm';
    else if (weeks < 32) pretermCategory = 'Very preterm';
    else if (weeks < 34) pretermCategory = 'Moderate preterm';
    else if (weeks < 37) pretermCategory = 'Late preterm';
  }

  // Determine weight category with proper terminology
  let weightCategory = '';
  if (patient.birthWeight !== undefined) {
    const wt = patient.birthWeight;
    if (wt < 1) weightCategory = 'ELBW';
    else if (wt < 1.5) weightCategory = 'VLBW';
    else if (wt < 2.5) weightCategory = 'LBW';
    else if (wt >= 4) weightCategory = 'LGA';
  }

  // Check for SGA/AGA/LGA based on gestational age and weight
  let growthStatus = '';
  if (patient.gestationalAgeWeeks && patient.birthWeight) {
    // Simplified check - can be enhanced with growth charts
    const expectedWeight = patient.gestationalAgeWeeks * 0.1; // Rough estimate
    if (patient.birthWeight < expectedWeight * 0.8) growthStatus = 'SGA';
  }

  const prompt = `You are a neonatologist writing a FINAL DIAGNOSIS for discharge. Generate an ACCURATE, CONCISE diagnosis.

=== PATIENT DATA ===
Unit: ${patient.unit}
Gestational Age: ${gaString || 'Term (≥37 weeks)'}
${pretermCategory ? `Preterm Category: ${pretermCategory}` : ''}
Birth Weight: ${patient.birthWeight ? `${patient.birthWeight} kg` : 'Unknown'}
${weightCategory ? `Weight Category: ${weightCategory}` : ''}
${growthStatus ? `Growth Status: ${growthStatus}` : ''}
Gender: ${patient.gender}

Admission Diagnosis: ${patient.diagnosis}
Indications for Admission: ${patient.indicationsForAdmission?.join(', ') || 'Not specified'}

Medications Given: ${(patient.medications || []).map(m => m.name).join(', ') || 'None'}

Clinical Notes: ${notesText || 'None documented'}

=== STANDARD NEONATAL DIAGNOSES (ICD-10 aligned) ===
PREMATURITY:
- Preterm infant, [GA] weeks gestation
- Extreme prematurity (<28 weeks)
- Very preterm (28-31 weeks)
- Moderate to late preterm (32-36 weeks)

BIRTH WEIGHT:
- ELBW - Extremely Low Birth Weight (<1000g)
- VLBW - Very Low Birth Weight (1000-1499g)
- LBW - Low Birth Weight (1500-2499g)
- SGA - Small for Gestational Age
- AGA - Appropriate for Gestational Age

RESPIRATORY:
- Respiratory Distress Syndrome (RDS) / Hyaline Membrane Disease
- Transient Tachypnea of Newborn (TTN)
- Meconium Aspiration Syndrome (MAS)
- Bronchopulmonary Dysplasia (BPD)
- Apnea of Prematurity

INFECTIONS:
- Neonatal Sepsis (Early-onset / Late-onset)
- Suspected Sepsis
- Pneumonia

METABOLIC/OTHER:
- Neonatal Hyperbilirubinemia / Neonatal Jaundice
- Hypoglycemia
- Perinatal Asphyxia / Birth Asphyxia
- Hypoxic Ischemic Encephalopathy (HIE)
- Neonatal Seizures
- Anemia of Prematurity
- Feeding Intolerance

=== OUTPUT FORMAT ===
Write diagnosis in this EXACT format:
[Preterm/Term status], [Weight category if abnormal], [Primary Diagnosis] - [Status], [Secondary if any] - [Status]

STATUS OPTIONS: Recovered, Resolved, Stable, Improving

=== EXAMPLES OF CORRECT OUTPUT ===
1. "Preterm (32+4 weeks), VLBW, Respiratory Distress Syndrome - Recovered, Neonatal Sepsis"
2. "Late preterm (35 weeks), LBW, Neonatal Hyperbilirubinemia - Resolved"
3. "Extreme preterm (26 weeks), ELBW, RDS - Recovered, Apnea of Prematurity - Resolved, Sepsis"
4. "Term, Meconium Aspiration Syndrome - Recovered"
5. "Very preterm (30 weeks), VLBW, SGA, Suspected Sepsis, Hypoglycemia - Resolved"
6. "Term, Birth Asphyxia with HIE Stage 1 - Recovered"

=== RULES ===
1. Be ACCURATE - use correct medical terminology
2. Include gestational age in parentheses for preterm
3. List weight category only if abnormal (ELBW/VLBW/LBW/SGA)
4. Use full diagnosis names (can abbreviate RDS, HIE, TTN, MAS, BPD)
5. Add outcome status for each diagnosis
6. Keep it ONE LINE, concise but complete
7. NO explanations, just the diagnosis`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT, {
      temperature: 0.2,
      maxTokens: 150
    });

    // Clean up the result
    let diagnosis = result.trim()
      .replace(/^["']|["']$/g, '') // Remove quotes
      .replace(/\n.*/g, '') // Keep only first line
      .replace(/^(Final )?[Dd]iagnosis:?\s*/i, '') // Remove "Diagnosis:" prefix
      .replace(/^\d+\.\s*/, ''); // Remove numbering if present

    return diagnosis || patient.diagnosis;
  } catch (error) {
    console.error('Error generating final diagnosis:', error);
    // Return an accurate fallback diagnosis
    const parts = [];

    if (patient.gestationalAgeWeeks && patient.gestationalAgeWeeks < 37) {
      const weeks = patient.gestationalAgeWeeks;
      const days = patient.gestationalAgeDays || 0;
      const gaStr = days > 0 ? `${weeks}+${days} weeks` : `${weeks} weeks`;
      if (weeks < 32) parts.push(`Very preterm (${gaStr})`);
      else if (weeks < 34) parts.push(`Moderate preterm (${gaStr})`);
      else parts.push(`Late preterm (${gaStr})`);
    } else {
      parts.push('Term');
    }

    if (weightCategory) {
      parts.push(weightCategory);
    }

    // Add the primary diagnosis
    parts.push(patient.diagnosis);

    return parts.join(', ');
  }
};

// ============================================================================
// DEATH CERTIFICATE AI FUNCTIONS (MCCD Form 4 - WHO ICD-10)
// ============================================================================

/**
 * Generate AI-powered Cause of Death Analysis following WHO ICD-10 guidelines
 * Returns structured cause of death with ICD-10 codes
 */
export const generateCauseOfDeathAnalysis = async (patient: Patient): Promise<{
  partI: {
    immediateCause: string;
    immediateCauseICD10: string;
    immediateCauseDuration: string;
    antecedentCause?: string;
    antecedentCauseICD10?: string;
    antecedentCauseDuration?: string;
    underlyingCause?: string;
    underlyingCauseICD10?: string;
    underlyingCauseDuration?: string;
  };
  partII: Array<{
    condition: string;
    icd10Code: string;
    duration: string;
  }>;
  summary: string;
  nhmCategory: string;
}> => {
  const isNeonatal = patient.unit === Unit.NICU || patient.unit === Unit.SNCU;

  // Build clinical context
  const clinicalContext = buildPatientContext(patient);

  const systemPrompt = `You are a senior medical officer specialized in mortality classification and ICD-10 coding for India's Medical Certificate of Cause of Death (MCCD Form 4). You follow WHO guidelines for cause of death certification.

IMPORTANT RULES:
1. The UNDERLYING CAUSE is the disease/injury that started the chain of events leading to death
2. Causes must flow logically from underlying → antecedent → immediate
3. Never use "cardiac arrest", "respiratory failure", or "cardiorespiratory failure" as causes - these are modes of dying, not causes
4. Use proper medical terminology with ICD-10 codes
5. Duration should be approximate time between onset and death

For neonatal deaths, consider:
- Birth asphyxia (P21)
- Prematurity complications (P07)
- Neonatal sepsis (P36)
- Respiratory distress syndrome (P22)
- Congenital anomalies (Q00-Q99)
- Meconium aspiration (P24.0)

For pediatric deaths, consider:
- Pneumonia (J12-J18)
- Sepsis (A40-A41)
- Meningitis (G00-G03)
- Diarrheal diseases (A00-A09)
- Congenital heart disease (Q20-Q28)`;

  const prompt = `Analyze this ${isNeonatal ? 'neonatal' : 'pediatric'} death case and provide the cause of death in WHO MCCD format:

${clinicalContext}

Provide a JSON response with this exact structure:
{
  "partI": {
    "immediateCause": "The immediate/direct cause of death",
    "immediateCauseICD10": "ICD-10 code",
    "immediateCauseDuration": "Duration (e.g., '2 hours', '3 days')",
    "antecedentCause": "Condition that led to immediate cause (if any)",
    "antecedentCauseICD10": "ICD-10 code",
    "antecedentCauseDuration": "Duration",
    "underlyingCause": "Original disease/condition that started the sequence",
    "underlyingCauseICD10": "ICD-10 code",
    "underlyingCauseDuration": "Duration"
  },
  "partII": [
    {
      "condition": "Other significant condition contributing to death",
      "icd10Code": "ICD-10 code",
      "duration": "Duration"
    }
  ],
  "summary": "Brief clinical summary of events leading to death (2-3 sentences)",
  "nhmCategory": "NHM Child Death Review category (e.g., 'Neonatal Sepsis', 'Birth Asphyxia', 'Prematurity/LBW', 'Pneumonia', etc.)"
}`;

  try {
    const response = await callOpenAI(prompt, systemPrompt, {
      model: 'gpt-4o',
      temperature: 0.2,
      maxTokens: 1500,
      jsonMode: true
    });

    const result = JSON.parse(response);
    return result;
  } catch (error) {
    console.error('Error generating cause of death analysis:', error);
    // Return a structured fallback
    return {
      partI: {
        immediateCause: patient.diagnosis || 'To be determined',
        immediateCauseICD10: 'R99',
        immediateCauseDuration: 'Unknown'
      },
      partII: [],
      summary: `${patient.name} was admitted with ${patient.diagnosis}. Further analysis required.`,
      nhmCategory: 'Other'
    };
  }
};

/**
 * Generate ICD-10 code suggestions for a given diagnosis
 */
export const suggestICD10Codes = async (diagnosis: string, isNeonatal: boolean = false): Promise<Array<{
  code: string;
  description: string;
  confidence: number;
}>> => {
  const systemPrompt = `You are an ICD-10 coding expert for medical mortality classification in India. Provide accurate ICD-10 codes for the given diagnosis.

For neonatal conditions, use P00-P96 codes primarily.
For pediatric conditions, use appropriate chapter codes.

Return ONLY the most relevant 3-5 codes with confidence scores.`;

  const prompt = `Provide ICD-10 codes for this ${isNeonatal ? 'neonatal' : 'pediatric'} diagnosis: "${diagnosis}"

Return JSON array:
[
  {"code": "P21.0", "description": "Severe birth asphyxia", "confidence": 0.95},
  {"code": "P21.1", "description": "Mild and moderate birth asphyxia", "confidence": 0.80}
]`;

  try {
    const response = await callOpenAI(prompt, systemPrompt, {
      model: 'gpt-4o-mini',
      temperature: 0.1,
      maxTokens: 500,
      jsonMode: true
    });

    const result = JSON.parse(response);
    return Array.isArray(result) ? result : [];
  } catch (error) {
    console.error('Error suggesting ICD-10 codes:', error);
    return [{
      code: 'R99',
      description: 'Other ill-defined and unspecified causes of mortality',
      confidence: 0.5
    }];
  }
};

/**
 * Generate clinical course summary for death certificate
 */
export const generateDeathClinicalSummary = async (patient: Patient): Promise<string> => {
  // Extract ALL clinical notes - CRITICAL for accurate death certificate
  const allClinicalNotes = extractAllClinicalNotesForAnalysis(patient);
  const isNeonatal = patient.unit === Unit.NICU || patient.unit === Unit.SNCU;

  const systemPrompt = `You are a senior neonatologist/pediatrician writing a clinical course summary for a LEGAL death certificate.
CRITICAL: This is a legal document. You MUST ONLY include information that is EXPLICITLY documented.
DO NOT speculate, assume, or invent any clinical details.
If something is not documented, write "not documented" - DO NOT MAKE IT UP.`;

  const prompt = `Write a clinical course summary (150-200 words) for the death certificate.

=== PATIENT ===
Name: ${patient.name}
Age: ${patient.age || 'Not documented'} ${patient.ageUnit || ''}
Unit: ${patient.unit}
Admission Date: ${patient.admissionDate}
Date of Death: ${patient.dateOfDeath || patient.releaseDate || 'Not documented'}
Admission Diagnosis: ${patient.diagnosis || 'Not documented'}

=== COMPLETE CLINICAL DOCUMENTATION ===
${allClinicalNotes || 'No detailed clinical notes available'}

=== RULES ===
1. ONLY include information that is EXPLICITLY documented above
2. If terminal events are not documented, write "Terminal events were not documented in the clinical notes"
3. DO NOT add treatments that are not documented (e.g., don't assume "IV fluids" unless documented)
4. DO NOT add complications that are not documented
5. Use proper medical terminology and passive voice
6. Start with: "${isNeonatal ? 'Baby' : 'Child'} was admitted on [date] with [documented diagnosis]..."
7. End with: "Despite [documented treatments], ${isNeonatal ? 'baby' : 'child'} succumbed to illness on [date]."

Write the clinical course summary now:`;

  try {
    const response = await callOpenAI(prompt, systemPrompt, {
      model: 'gpt-4o',
      temperature: 0.2, // Lower temperature for more factual output
      maxTokens: 400
    });

    return response;
  } catch (error) {
    console.error('Error generating death clinical summary:', error);
    const isNeonatal = patient.unit === Unit.NICU || patient.unit === Unit.SNCU;
    return `${isNeonatal ? 'Baby' : 'Child'} ${patient.name} was admitted on ${patient.admissionDate} with ${patient.diagnosis || 'diagnosis as documented'}. Clinical course is detailed in the medical records. ${isNeonatal ? 'Baby' : 'Child'} succumbed on ${patient.dateOfDeath || patient.releaseDate || 'date as documented'}.`;
  }
};

/**
 * Generate treatment summary for death certificate
 */
export const generateDeathTreatmentSummary = async (patient: Patient): Promise<string[]> => {
  // Extract treatments from medications and progress notes
  const medications = patient.medications || [];
  const progressNotes = patient.progressNotes || [];

  const treatments: string[] = [];

  // Add medications as treatments
  medications.forEach(med => {
    if (med.isActive !== false) {
      const parts = [med.name];
      if (med.dose) parts.push(med.dose);
      if (med.route) parts.push(`(${med.route})`);
      if (med.frequency) parts.push(`- ${med.frequency}`);
      treatments.push(parts.join(' '));
    }
  });

  // If we have progress notes, try to extract additional treatments
  if (progressNotes.length > 0 && treatments.length < 5) {
    const latestNotes = progressNotes.slice(-3).map(n => n.note || '').join('\n');

    const systemPrompt = `Extract the main treatments/interventions mentioned in these clinical notes. Return as JSON array of strings.`;

    try {
      const response = await callOpenAI(
        `Extract treatments from: ${latestNotes}\n\nReturn JSON array: ["Treatment 1", "Treatment 2"]`,
        systemPrompt,
        { model: 'gpt-4o-mini', temperature: 0.1, maxTokens: 300, jsonMode: true }
      );

      const additionalTreatments = JSON.parse(response);
      if (Array.isArray(additionalTreatments)) {
        additionalTreatments.forEach(t => {
          if (!treatments.includes(t)) {
            treatments.push(t);
          }
        });
      }
    } catch (e) {
      // Ignore errors, just use medication list
    }
  }

  // DO NOT add assumed/common treatments for death certificate
  // This is a legal document - only include DOCUMENTED treatments
  // If no treatments documented, return empty array - don't make up data

  // Also extract treatments from respiratory support if documented
  if (patient.progressNotes && patient.progressNotes.length > 0) {
    patient.progressNotes.forEach(note => {
      if (note.respiratorySupport?.type && !treatments.some(t => t.toLowerCase().includes(note.respiratorySupport!.type!.toLowerCase()))) {
        treatments.push(note.respiratorySupport.type);
      }
    });
  }

  return treatments.slice(0, 15); // Limit to 15 treatments
};

/**
 * Determine NHM Child Death Review category based on diagnosis
 */
export const determineNHMDeathCategory = (patient: Patient): string => {
  const diagnosis = (patient.diagnosis || '').toLowerCase();
  const finalDiagnosis = (patient.diagnosisAtDeath || '').toLowerCase();
  const combined = `${diagnosis} ${finalDiagnosis}`;

  const isNeonatal = patient.unit === Unit.NICU || patient.unit === Unit.SNCU;

  if (isNeonatal) {
    // Neonatal categories
    if (combined.includes('asphyxia') || combined.includes('hie')) return 'Birth Asphyxia';
    if (combined.includes('preterm') || combined.includes('prematur') || combined.includes('lbw') || combined.includes('vlbw') || combined.includes('elbw')) return 'Prematurity/Low Birth Weight';
    if (combined.includes('sepsis') || combined.includes('septic')) return 'Neonatal Sepsis';
    if (combined.includes('rds') || combined.includes('respiratory distress syndrome')) return 'Respiratory Distress Syndrome';
    if (combined.includes('mas') || combined.includes('meconium aspiration')) return 'Meconium Aspiration Syndrome';
    if (combined.includes('congenital') || combined.includes('anomal') || combined.includes('malformation')) return 'Congenital Anomalies';
    if (combined.includes('jaundice') || combined.includes('hyperbilirubinemia')) return 'Severe Neonatal Jaundice';
    if (combined.includes('hypothermia')) return 'Hypothermia';
    if (combined.includes('feeding') || combined.includes('nec') || combined.includes('necrotizing')) return 'Feeding Problems';
  } else {
    // Pediatric categories
    if (combined.includes('pneumonia')) return 'Pneumonia';
    if (combined.includes('diarrhea') || combined.includes('dehydration') || combined.includes('gastroenteritis')) return 'Diarrhea with Dehydration';
    if (combined.includes('malaria')) return 'Severe Malaria';
    if (combined.includes('measles')) return 'Measles';
    if (combined.includes('meningitis') || combined.includes('encephalitis')) return 'Meningitis/Encephalitis';
    if (combined.includes('malnutrition') || combined.includes('sam') || combined.includes('severe acute')) return 'Severe Acute Malnutrition';
    if (combined.includes('dengue')) return 'Dengue Shock Syndrome';
    if (combined.includes('sepsis') || combined.includes('septic')) return 'Sepsis/Septic Shock';
    if (combined.includes('trauma') || combined.includes('injury') || combined.includes('accident')) return 'Trauma/Injury';
    if (combined.includes('drowning')) return 'Drowning';
    if (combined.includes('poison')) return 'Poisoning';
    if (combined.includes('heart') || combined.includes('cardiac') || combined.includes('chd')) return 'Congenital Heart Disease';
  }

  return 'Other';
};

// ============================================================================
// UTILITY EXPORTS
// ============================================================================

export const clearAICache = () => {
  aiCache.clear();
  console.log('AI cache cleared');
};

export const getAICacheStats = () => {
  return {
    size: aiCache.size,
    entries: Array.from(aiCache.keys())
  };
};

// Export the raw callOpenAI for other services that need it
export { callOpenAI };

// ============================================================================
// ENHANCED CLINICAL INTELLIGENCE FUNCTIONS
// Uses Clinical Intelligence Service for accurate diagnosis generation
// ============================================================================

import {
  generateComprehensiveClinicalSummary,
  getValidatedGestationalAge,
  analyzeWeight,
  analyzeClinicalCourse,
  ComprehensiveClinicalSummary,
  ClinicalCourseAnalysis,
  GestationalCategory,
  WeightCategory,
  GrowthStatus
} from './clinicalIntelligenceService';

/**
 * Enhanced Final Diagnosis Generator
 * Uses Clinical Intelligence Service for accurate, validated diagnosis
 * Cross-correlates LMP, EDD, gestational age, indications, notes, and medications
 */
export const generateEnhancedFinalDiagnosis = async (patient: Patient): Promise<{
  diagnosis: string;
  warnings: string[];
  clinicalSummary: ComprehensiveClinicalSummary;
}> => {
  // Generate comprehensive clinical summary
  const clinicalSummary = generateComprehensiveClinicalSummary(patient);

  // Extract validated data
  const ga = clinicalSummary.gestationalAge;
  const weight = clinicalSummary.weightAnalysis;
  const course = clinicalSummary.clinicalCourse;
  const diagnosisAnalysis = clinicalSummary.diagnosis;

  // Collect all warnings
  const warnings = clinicalSummary.warnings.map(w => w.message);

  // Build diagnosis parts
  const diagnosisParts: string[] = [];

  // 1. Gestational Age Status (CRITICAL - must be accurate)
  if (ga.weeks > 0 && ga.weeks < 37) {
    const gaStr = ga.days > 0 ? `${ga.weeks}+${ga.days}` : `${ga.weeks}`;

    switch (ga.category) {
      case GestationalCategory.EXTREME_PRETERM:
        diagnosisParts.push(`Extreme preterm (${gaStr} weeks)`);
        break;
      case GestationalCategory.VERY_PRETERM:
        diagnosisParts.push(`Very preterm (${gaStr} weeks)`);
        break;
      case GestationalCategory.MODERATE_PRETERM:
        diagnosisParts.push(`Moderate preterm (${gaStr} weeks)`);
        break;
      case GestationalCategory.LATE_PRETERM:
        diagnosisParts.push(`Late preterm (${gaStr} weeks)`);
        break;
    }
  } else if (ga.weeks >= 37) {
    // Only mention term if patient is neonatal
    if (clinicalSummary.patientProfile.isNeonatal) {
      if (ga.category === GestationalCategory.EARLY_TERM) {
        diagnosisParts.push('Early term');
      } else if (ga.category === GestationalCategory.POST_TERM) {
        diagnosisParts.push(`Post term (${ga.weeks} weeks)`);
      } else {
        diagnosisParts.push('Term');
      }
    }
  }

  // 2. Weight Category (if abnormal)
  if (weight && weight.category !== WeightCategory.NORMAL) {
    diagnosisParts.push(weight.categoryAbbreviation);
  }

  // 3. Growth Status (if SGA or LGA)
  if (weight?.growthStatus === GrowthStatus.SGA) {
    diagnosisParts.push('SGA');
  } else if (weight?.growthStatus === GrowthStatus.LGA) {
    diagnosisParts.push('LGA');
  }

  // 4. Primary Diagnosis with Status
  // Parse the admission diagnosis to extract the main condition(s)
  const primaryDiagnosis = patient.diagnosis || 'Unknown';
  const status = determineOutcomeStatus(patient, course);

  // Clean up the primary diagnosis - remove duplicates with GA/weight info already added
  let cleanedPrimaryDiagnosis = primaryDiagnosis;

  // Remove GA info if already included
  if (diagnosisParts.some(p => p.toLowerCase().includes('preterm') || p.toLowerCase().includes('term'))) {
    cleanedPrimaryDiagnosis = cleanedPrimaryDiagnosis
      .replace(/\b(extreme|very|moderate|late)?\s*preterm\b/gi, '')
      .replace(/\bterm\b/gi, '')
      .replace(/\d+\+?\d*\s*weeks?\b/gi, '')
      .trim();
  }

  // Remove weight categories if already included
  if (diagnosisParts.some(p => /\b(ELBW|VLBW|LBW|NBW|SGA|LGA)\b/i.test(p))) {
    cleanedPrimaryDiagnosis = cleanedPrimaryDiagnosis
      .replace(/\b(ELBW|VLBW|LBW|NBW|SGA|LGA)\b/gi, '')
      .replace(/\blow\s*birth\s*weight\b/gi, '')
      .replace(/\bvery\s*low\s*birth\s*weight\b/gi, '')
      .replace(/\bextremely\s*low\s*birth\s*weight\b/gi, '')
      .trim();
  }

  // Clean up any leading/trailing commas or extra spaces
  cleanedPrimaryDiagnosis = cleanedPrimaryDiagnosis
    .replace(/^[\s,]+|[\s,]+$/g, '')
    .replace(/\s+/g, ' ')
    .replace(/,\s*,/g, ',')
    .trim();

  if (cleanedPrimaryDiagnosis && cleanedPrimaryDiagnosis !== 'Unknown') {
    if (status === 'Treated' || status === '' || status === 'Recovered') {
      diagnosisParts.push(cleanedPrimaryDiagnosis);
    } else {
      diagnosisParts.push(`${cleanedPrimaryDiagnosis} - ${status}`);
    }
  }

  // 5. Only add CONFIRMED secondary diagnoses that are:
  //    a) From admission indications (explicitly stated reasons for admission)
  //    b) Clearly different from primary diagnosis
  //    c) Significant enough to warrant documentation

  // Get admission indications as they are confirmed reasons for admission
  const admissionIndications = patient.indicationsForAdmission || [];
  const indicationsNotInPrimary = admissionIndications.filter(ind => {
    const indLower = ind.toLowerCase();
    const primaryLower = primaryDiagnosis.toLowerCase();
    // Don't add if already covered in primary diagnosis or in diagnosisParts
    return !primaryLower.includes(indLower.split(' ')[0]) &&
           !diagnosisParts.some(p => p.toLowerCase().includes(indLower.split(' ')[0]));
  });

  // Only add top 2 additional indications if they're significant conditions
  const significantConditions = [
    'sepsis', 'pneumonia', 'rds', 'respiratory distress', 'birth asphyxia', 'hie',
    'jaundice', 'hyperbilirubinemia', 'meningitis', 'seizure', 'shock',
    'nec', 'apnea', 'mas', 'ttn', 'hypoglycemia'
  ];

  const significantSecondary = indicationsNotInPrimary
    .filter(ind => significantConditions.some(c => ind.toLowerCase().includes(c)))
    .slice(0, 2);

  significantSecondary.forEach(condition => {
    const condStatus = course.resolvedConditions.some(r =>
      r.toLowerCase().includes(condition.toLowerCase().split(' ')[0])
    ) ? 'Resolved' : '';

    if (condStatus) {
      diagnosisParts.push(`${condition} - ${condStatus}`);
    } else {
      diagnosisParts.push(condition);
    }
  });

  // FINAL VALIDATION: Remove any conditions that are speculative or shouldn't be in discharge diagnosis
  // These are conditions that are often mentioned but rarely confirmed as actual diagnoses
  const speculativeConditions = [
    /\bdic\b/i,  // DIC is rarely a primary diagnosis, usually a complication
    /\bcoagulopathy\b/i,  // Often mentioned in workup, rarely confirmed
    /\bcardiac\s+arrest\b/i,  // Mode of dying, not a diagnosis
    /\brespiratory\s+failure\b/i,  // Mode of dying, not a diagnosis
    /\bmulti.?organ\s+failure\b/i,  // Mode of dying, not a diagnosis
    /\bunknown\b/i  // Unknown is not a diagnosis
  ];

  const filteredParts = diagnosisParts.filter(part => {
    return !speculativeConditions.some(pattern => pattern.test(part));
  });

  // Combine into final diagnosis
  const finalDiagnosis = filteredParts.length > 0 ? filteredParts.join(', ') : patient.diagnosis || 'Observation';

  // If AI enhancement is available, use it to polish the diagnosis
  try {
    const polishedDiagnosis = await polishDiagnosisWithAI(
      finalDiagnosis,
      clinicalSummary,
      patient
    );
    return {
      diagnosis: polishedDiagnosis,
      warnings,
      clinicalSummary
    };
  } catch (error) {
    console.error('AI diagnosis polish failed, using rule-based diagnosis:', error);
    return {
      diagnosis: finalDiagnosis,
      warnings,
      clinicalSummary
    };
  }
};

/**
 * Polish diagnosis with AI while maintaining clinical accuracy
 * ENHANCED: Now analyzes ALL clinical notes to write diagnosis like a pediatrician
 * But still validates against actual documented conditions to avoid speculation
 */
async function polishDiagnosisWithAI(
  baseDiagnosis: string,
  summary: ComprehensiveClinicalSummary,
  patient: Patient
): Promise<string> {
  // Extract all clinical notes for comprehensive analysis
  const allClinicalNotes = extractAllClinicalNotesForAnalysis(patient);
  const course = summary.clinicalCourse;
  const isNeonatal = summary.patientProfile.isNeonatal;

  // Extract primary sources of truth
  const indicationsForAdmission = patient.indicationsForAdmission?.join(', ') || '';
  const admissionDiagnosis = patient.diagnosis || '';

  const prompt = `You are a SENIOR NEONATOLOGIST writing the FINAL DIAGNOSIS for a discharge summary.

=== ABSOLUTE RULE ===
ONLY use diagnoses that are EXPLICITLY written in:
1. Indications for Admission
2. Admission Diagnosis
3. Progress Notes
DO NOT invent or assume ANY diagnosis.

=== PRIMARY DATA SOURCES ===
INDICATIONS FOR ADMISSION: ${indicationsForAdmission || 'Not specified'}
ADMISSION DIAGNOSIS: ${admissionDiagnosis || 'Not specified'}

=== VALIDATED DATA (mathematically calculated - DO NOT CHANGE) ===
Gestational Age: ${summary.gestationalAge.weeks > 0 ? `${summary.gestationalAge.weeks}+${summary.gestationalAge.days} weeks (${summary.gestationalAge.categoryDescription})` : 'Term'}
Birth Weight: ${summary.weightAnalysis.weightInGrams}g (${summary.weightAnalysis.categoryAbbreviation})
${summary.weightAnalysis.growthStatus ? `Growth: ${summary.weightAnalysis.growthStatus}` : ''}

=== PROGRESS NOTES SUMMARY ===
${allClinicalNotes || 'No detailed clinical notes available'}

=== YOUR TASK ===
Write the FINAL DIAGNOSIS using ONLY:
1. GA status (from validated data above)
2. Weight category (from validated data above)
3. Diagnoses EXPLICITLY listed in indications/admission diagnosis
4. Conditions EXPLICITLY documented in progress notes

=== STRICT RULES ===
1. NEVER add DIC, coagulopathy, multi-organ failure, shock unless WRITTEN in notes
2. NEVER assume a complication that isn't documented
3. If admission says "Preterm, LBW, RDS" - write EXACTLY "Preterm, LBW, RDS" with proper formatting
4. Add "Resolved" or "Treated" ONLY if progress notes document resolution
5. Maximum 5-6 diagnoses, comma-separated, one line only
6. Example format: "Late preterm (35+3 weeks), LBW (1.8 kg), RDS - Resolved, Sepsis screen negative"

=== BASE DIAGNOSIS TO FORMAT ===
"${baseDiagnosis}"

Write the final diagnosis now (ONLY the diagnosis text, nothing else):`

  const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT, {
    model: OPENAI_MODEL_FAST, // Use faster model for better quality
    temperature: 0.2,
    maxTokens: 150
  });

  // Clean the result
  const polished = result.trim()
    .replace(/^["']|["']$/g, '')
    .replace(/\n.*/g, '')
    .replace(/^(Final )?[Dd]iagnosis:?\s*/i, '');

  // Validate that the AI didn't incorrectly change preterm/term status
  const originalIsPreterm = summary.gestationalAge.weeks < 37;
  const polishedLower = polished.toLowerCase();

  if (originalIsPreterm && polishedLower.includes('term') && !polishedLower.includes('preterm')) {
    console.warn('AI incorrectly changed preterm to term, using base diagnosis');
    return baseDiagnosis;
  }

  if (!originalIsPreterm && polishedLower.includes('preterm')) {
    console.warn('AI incorrectly changed term to preterm, using base diagnosis');
    return baseDiagnosis;
  }

  return polished || baseDiagnosis;
}

function determineOutcomeStatus(patient: Patient, course: ClinicalCourseAnalysis): string {
  if (patient.outcome === 'Discharged') {
    if (course.clinicalImprovement) {
      return 'Recovered';
    }
    return 'Treated';
  }

  if (patient.outcome === 'Deceased') {
    return ''; // No status for deceased
  }

  if (course.clinicalImprovement) {
    return 'Improving';
  }

  return 'Stable';
}

/**
 * Extract ALL clinical notes text from patient for comprehensive AI analysis
 * Like a pediatrician reviewing the entire chart before discharge
 */
const extractAllClinicalNotesForAnalysis = (patient: Patient): string => {
  const sections: string[] = [];

  // 1. Admission details and indications
  if (patient.indicationsForAdmission && patient.indicationsForAdmission.length > 0) {
    sections.push(`INDICATIONS FOR ADMISSION:\n${patient.indicationsForAdmission.join(', ')}`);
  }

  // 2. All progress notes with full content
  if (patient.progressNotes && patient.progressNotes.length > 0) {
    const notesText = patient.progressNotes
      .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())
      .map((note, idx) => {
        const noteDate = new Date(note.date).toLocaleDateString();
        let noteContent = `Day ${idx + 1} (${noteDate}):\n`;

        // Clinical note text
        if (note.note) noteContent += `- Note: ${note.note}\n`;

        // Examination findings
        if (note.examination) {
          const examParts: string[] = [];
          if (note.examination.general) examParts.push(`General: ${note.examination.general}`);
          if (note.examination.respiratory) examParts.push(`Respiratory: ${note.examination.respiratory}`);
          if (note.examination.cardiovascular) examParts.push(`CVS: ${note.examination.cardiovascular}`);
          if (note.examination.abdominal) examParts.push(`Abdomen: ${note.examination.abdominal}`);
          if (note.examination.cns) examParts.push(`CNS: ${note.examination.cns}`);
          if (note.examination.skin) examParts.push(`Skin: ${note.examination.skin}`);
          if (examParts.length > 0) noteContent += `- Examination: ${examParts.join('; ')}\n`;
        }

        // Vitals
        if (note.vitals) {
          const vitals: string[] = [];
          if (note.vitals.temperature) vitals.push(`Temp: ${note.vitals.temperature}°C`);
          if (note.vitals.heartRate) vitals.push(`HR: ${note.vitals.heartRate}/min`);
          if (note.vitals.respiratoryRate) vitals.push(`RR: ${note.vitals.respiratoryRate}/min`);
          if (note.vitals.spo2) vitals.push(`SpO2: ${note.vitals.spo2}%`);
          if (note.vitals.weight) vitals.push(`Wt: ${note.vitals.weight}g`);
          if (vitals.length > 0) noteContent += `- Vitals: ${vitals.join(', ')}\n`;
        }

        // Medications in this note
        if (note.medications && note.medications.length > 0) {
          const meds = note.medications.map(m => m.name).filter(Boolean).join(', ');
          if (meds) noteContent += `- Medications: ${meds}\n`;
        }

        // Feeding
        if (note.feeding) {
          const feedParts: string[] = [];
          if (note.feeding.type) feedParts.push(note.feeding.type);
          if (note.feeding.volume) feedParts.push(`${note.feeding.volume}ml`);
          if (note.feeding.frequency) feedParts.push(note.feeding.frequency);
          if (feedParts.length > 0) noteContent += `- Feeding: ${feedParts.join(' ')}\n`;
        }

        // Respiratory support
        if (note.respiratorySupport) {
          const respParts: string[] = [];
          if (note.respiratorySupport.type) respParts.push(note.respiratorySupport.type);
          if (note.respiratorySupport.fio2) respParts.push(`FiO2: ${note.respiratorySupport.fio2}%`);
          if (respParts.length > 0) noteContent += `- Respiratory: ${respParts.join(' ')}\n`;
        }

        return noteContent;
      })
      .join('\n');

    sections.push(`PROGRESS NOTES (${patient.progressNotes.length} notes):\n${notesText}`);
  }

  // 3. All medications received
  if (patient.medications && patient.medications.length > 0) {
    const medsText = patient.medications
      .filter(m => m.name)
      .map(m => {
        let medStr = m.name;
        if (m.dose) medStr += ` ${m.dose}`;
        if (m.route) medStr += ` ${m.route}`;
        if (m.startDate) {
          const start = new Date(m.startDate);
          const end = m.stopDate ? new Date(m.stopDate) : new Date();
          const days = Math.ceil((end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24));
          medStr += ` (${days} days)`;
        }
        return medStr;
      })
      .join('\n- ');
    sections.push(`MEDICATIONS RECEIVED:\n- ${medsText}`);
  }

  // 4. Lab investigations
  if (patient.labInvestigations && patient.labInvestigations.length > 0) {
    const labsText = patient.labInvestigations
      .map(lab => `${lab.name}: ${lab.value} ${lab.unit || ''} (${lab.date})`)
      .join('\n- ');
    sections.push(`LAB INVESTIGATIONS:\n- ${labsText}`);
  }

  return sections.join('\n\n');
};

/**
 * Enhanced Clinical Course Summary for Discharge
 * Analyzes ALL progress notes, medications, vitals comprehensively like a pediatrician
 */
export const generateEnhancedClinicalCourseSummary = async (patient: Patient): Promise<{
  summary: string;
  keyEvents: string[];
  treatmentProvided: string[];
  complications: string[];
  currentStatus: string;
  recommendations: string[];
}> => {
  const clinicalSummary = generateComprehensiveClinicalSummary(patient);
  const course = clinicalSummary.clinicalCourse;

  // Generate AI-enhanced clinical summary in proper medical documentation style
  const isNeonatal = clinicalSummary.patientProfile.isNeonatal;
  const gaInfo = isNeonatal && clinicalSummary.gestationalAge.weeks > 0
    ? `${clinicalSummary.gestationalAge.weeks}+${clinicalSummary.gestationalAge.days} weeks gestation`
    : '';
  const weightInfo = clinicalSummary.weightAnalysis.weightInGrams > 0
    ? `${clinicalSummary.weightAnalysis.weightInGrams}g`
    : '';

  // Extract ALL clinical notes for comprehensive analysis
  const allClinicalNotes = extractAllClinicalNotesForAnalysis(patient);

  const prompt = `You are a senior pediatrician/neonatologist writing the CLINICAL COURSE SUMMARY for a discharge summary.
You MUST carefully analyze ALL the clinical notes below and write like an experienced pediatrician would.

=== PATIENT PROFILE ===
${isNeonatal ? `Baby ${patient.gender === 'Male' ? 'boy' : 'girl'}` : `Child`}
${gaInfo ? `Gestational Age: ${gaInfo}` : ''}
${weightInfo ? `Birth Weight: ${weightInfo}` : ''}
Admission Diagnosis: ${patient.diagnosis}
Hospital Stay: ${course.totalDaysOfStay} days

=== COMPLETE CLINICAL DOCUMENTATION ===
${allClinicalNotes || 'No detailed clinical notes available'}

=== SUMMARY DATA ===
Respiratory Support Progression: ${course.respiratorySupportProgression.join(' → ') || 'Room air throughout'}
Feeding Progression: ${course.feedingProgression.join(' → ') || 'Direct breastfeeding'}
${course.complications.length > 0 ? `Documented Complications: ${course.complications.join(', ')}` : 'No complications documented'}

=== YOUR TASK ===
As the treating pediatrician, write a comprehensive CLINICAL COURSE SUMMARY analyzing:
1. Presenting complaints and condition at admission
2. Initial management and response to treatment
3. Day-by-day clinical progression (highlight significant changes)
4. All treatments given with duration (antibiotics, phototherapy, respiratory support, etc.)
5. Any complications and how they were managed
6. Current condition at discharge

=== WRITING STYLE ===
- Write in THIRD PERSON PASSIVE VOICE: "Baby was admitted...", "Treatment was initiated..."
- Write 150-200 words - be thorough but concise
- Use proper medical terminology: "respiratory distress" not "breathing problem"
- Expand abbreviations: "intravenous fluids" not "IV fluids", "room air" not "RA"
- Mention SPECIFIC medications by name with duration
- Include vital trends if significant (improving, stable, etc.)
- End with discharge condition and fitness for discharge

Write the clinical course summary now:`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT, {
      temperature: 0.3,
      maxTokens: 800 // Increased for comprehensive pediatric summary
    });

    // Also extract medications with duration for treatment list
    const treatmentsFromNotes: string[] = [];
    if (patient.medications && patient.medications.length > 0) {
      patient.medications.forEach(med => {
        if (med.name) {
          let medStr = med.name;
          if (med.startDate) {
            const start = new Date(med.startDate);
            const end = med.stopDate ? new Date(med.stopDate) : new Date();
            const days = Math.ceil((end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24));
            medStr += ` - ${days === 0 ? 'Single dose' : days === 1 ? '1 day' : `${days} days`}`;
          }
          treatmentsFromNotes.push(medStr);
        }
      });
    }
    // Also from progress notes
    if (patient.progressNotes) {
      patient.progressNotes.forEach(note => {
        if (note.medications) {
          note.medications.forEach(med => {
            if (med.name && !treatmentsFromNotes.some(t => t.toLowerCase().startsWith(med.name.toLowerCase()))) {
              treatmentsFromNotes.push(med.name);
            }
          });
        }
      });
    }

    return {
      summary: result.trim(),
      keyEvents: course.keyEvents.slice(0, 5).map(e => e.event),
      treatmentProvided: treatmentsFromNotes.length > 0 ? treatmentsFromNotes : course.interventions,
      complications: course.complications,
      currentStatus: course.overallAssessment,
      recommendations: clinicalSummary.dischargeReadiness?.recommendations || []
    };
  } catch (error) {
    console.error('Error generating clinical course summary:', error);
    return {
      summary: course.overallAssessment,
      keyEvents: course.keyEvents.slice(0, 5).map(e => e.event),
      treatmentProvided: course.interventions,
      complications: course.complications,
      currentStatus: course.overallAssessment,
      recommendations: []
    };
  }
};

/**
 * Enhanced Cause of Death Analysis with Clinical Intelligence
 * Follows WHO ICD-10 guidelines and validates against clinical course
 */
export const generateEnhancedCauseOfDeathAnalysis = async (patient: Patient): Promise<{
  partI: {
    immediateCause: string;
    immediateCauseICD10: string;
    immediateCauseDuration: string;
    antecedentCause?: string;
    antecedentCauseICD10?: string;
    antecedentCauseDuration?: string;
    underlyingCause?: string;
    underlyingCauseICD10?: string;
    underlyingCauseDuration?: string;
  };
  partII: Array<{
    condition: string;
    icd10Code: string;
    duration: string;
  }>;
  clinicalCourseSummary: string;
  terminalEvents: string;
  nhmCategory: string;
  warnings: string[];
}> => {
  const clinicalSummary = generateComprehensiveClinicalSummary(patient);
  const course = clinicalSummary.clinicalCourse;
  const ga = clinicalSummary.gestationalAge;

  const isNeonatal = patient.unit === Unit.NICU || patient.unit === Unit.SNCU;

  // Extract ALL clinical notes for comprehensive analysis - CRITICAL for accurate death certificate
  const allClinicalNotes = extractAllClinicalNotesForAnalysis(patient);

  // Build comprehensive clinical context WITH ALL DOCUMENTATION
  const clinicalContext = `
=== DECEASED PATIENT PROFILE ===
Name: ${patient.name}
Age: ${clinicalSummary.patientProfile.ageDescription}
Gender: ${patient.gender}
Unit: ${patient.unit}
${isNeonatal ? `
=== NEONATAL DETAILS ===
Gestational Age: ${ga.weeks > 0 ? `${ga.weeks}+${ga.days} weeks (${ga.category})` : 'Not documented'}
Birth Weight: ${clinicalSummary.weightAnalysis.weightInGrams > 0 ? `${clinicalSummary.weightAnalysis.weightInGrams}g (${clinicalSummary.weightAnalysis.categoryAbbreviation})` : 'Not documented'}
${clinicalSummary.weightAnalysis.growthStatus ? `Growth Status: ${clinicalSummary.weightAnalysis.growthStatus}` : ''}
Mode of Delivery: ${patient.modeOfDelivery || 'Not documented'}` : ''}

=== MATERNAL HISTORY ===
${clinicalSummary.maternalFactors.significantFactors.length > 0
      ? clinicalSummary.maternalFactors.significantFactors.join('\n')
      : 'No significant factors documented'}

=== ADMISSION DETAILS ===
Date of Admission: ${patient.admissionDate}
Admission Diagnosis: ${patient.diagnosis || 'Not documented'}
Indications for Admission: ${patient.indicationsForAdmission?.join(', ') || 'Not specified'}

=== COMPLETE CLINICAL DOCUMENTATION ===
${allClinicalNotes || 'No detailed clinical notes available'}

=== CLINICAL COURSE SUMMARY (${course.totalDaysOfStay} days) ===
Documented Interventions: ${course.interventions.join(', ') || 'Supportive care'}
Documented Complications: ${course.complications.join(', ') || 'None documented'}
Respiratory Support Used: ${course.respiratorySupportProgression.join(' → ') || 'Not documented'}

=== MEDICATIONS GIVEN ===
Antibiotics: ${course.medicationSummary.antibiotics.map(m => m.name).join(', ') || 'None documented'}
Inotropes/Vasopressors: ${course.medicationSummary.cardiovascularMeds.map(m => m.name).join(', ') || 'None documented'}

=== DEATH DETAILS ===
Date of Death: ${patient.dateOfDeath || patient.releaseDate || 'Not documented'}
Diagnosis at Death: ${patient.diagnosisAtDeath || patient.diagnosis || 'Not documented'}
`;

  // Extract ONLY indications for admission and progress notes - the primary sources of truth
  const indicationsForAdmission = patient.indicationsForAdmission?.join(', ') || patient.diagnosis || 'Not documented';
  const admissionDiagnosis = patient.diagnosis || 'Not documented';
  const diagnosisAtDeath = patient.diagnosisAtDeath || patient.diagnosis || 'Not documented';

  const prompt = `You are a SENIOR NEONATOLOGIST completing a MEDICAL CERTIFICATE OF CAUSE OF DEATH.

=== ABSOLUTE RULE - READ CAREFULLY ===
THIS IS A LEGAL DOCUMENT. You can ONLY use:
1. INDICATIONS FOR ADMISSION (primary source)
2. PROGRESS NOTES (what doctors actually wrote)
3. ADMISSION DIAGNOSIS
4. DIAGNOSIS AT DEATH (if documented)

YOU MUST NOT:
- Invent ANY diagnosis not explicitly written
- Add DIC, shock, multi-organ failure, coagulopathy, cardiac arrest unless WRITTEN
- Assume or imagine any condition
- Add "common complications" that aren't documented
- Make up terminal events

${clinicalContext}

=== PRIMARY DATA SOURCES (USE ONLY THESE) ===

INDICATIONS FOR ADMISSION: ${indicationsForAdmission}
ADMISSION DIAGNOSIS: ${admissionDiagnosis}
DIAGNOSIS AT DEATH: ${diagnosisAtDeath}

=== YOUR TASK ===
CORRELATE the indications, admission diagnosis, and progress notes ONLY.
Write ONLY what is documented. If not documented, leave blank or write "Not documented".

=== CAUSE OF DEATH CHAIN ===
(a) IMMEDIATE CAUSE: Use the diagnosis at death or final documented condition
(b) ANTECEDENT CAUSE: Use ONLY if clearly documented as leading to (a). Otherwise leave EMPTY.
(c) UNDERLYING CAUSE: Use the PRIMARY admission diagnosis or indication

=== STRICT RULES ===
1. If diagnosis says "Preterm, Low Birth Weight, RDS" - use EXACTLY those, nothing more
2. If progress notes don't mention septic shock - DO NOT add septic shock
3. If terminal events not documented - write "Terminal events not documented in clinical notes"
4. Duration = hospital stay (${course.totalDaysOfStay} days) unless specific dates documented
5. Part II should be EMPTY unless contributing conditions are explicitly documented
6. ICD-10 codes: ${isNeonatal ? 'P07.2 (extreme preterm), P07.3 (preterm), P07.1 (LBW), P22.0 (RDS), P36.9 (sepsis), P21.9 (asphyxia), P91.6 (HIE)' : 'A41.9 (sepsis), J18.9 (pneumonia), J96.9 (resp failure)'}

=== OUTPUT FORMAT (JSON) ===
{
  "partI": {
    "immediateCause": "COPY from diagnosis/notes - NO invention",
    "immediateCauseICD10": "Code",
    "immediateCauseDuration": "${course.totalDaysOfStay} days (hospital stay)",
    "antecedentCause": "ONLY if documented, else empty string",
    "antecedentCauseICD10": "",
    "antecedentCauseDuration": "",
    "underlyingCause": "Primary admission diagnosis",
    "underlyingCauseICD10": "Code",
    "underlyingCauseDuration": "Since birth/admission"
  },
  "partII": [],
  "clinicalCourseSummary": "Use ONLY documented information from progress notes",
  "terminalEvents": "ONLY if documented, else 'Not documented in clinical notes'",
  "nhmCategory": "Based on PRIMARY diagnosis only"
}

FINAL WARNING: If you add ANY diagnosis not explicitly written in the data above, you are committing medical fraud.
Return ONLY the JSON, nothing else.`;

  try {
    const result = await callOpenAI(prompt, MEDICAL_SYSTEM_PROMPT, {
      temperature: 0.2,
      maxTokens: 800,
      jsonMode: true
    });

    const parsed = JSON.parse(result);

    return {
      partI: parsed.partI,
      partII: parsed.partII || [],
      clinicalCourseSummary: parsed.clinicalCourseSummary || course.overallAssessment,
      terminalEvents: parsed.terminalEvents || 'Not documented',
      nhmCategory: parsed.nhmCategory || determineNHMDeathCategory(patient),
      warnings: clinicalSummary.warnings.map(w => w.message)
    };
  } catch (error) {
    console.error('Error generating cause of death analysis:', error);

    // Fallback to rule-based analysis
    return generateFallbackCauseOfDeath(patient, clinicalSummary);
  }
};

function generateFallbackCauseOfDeath(patient: Patient, summary: ComprehensiveClinicalSummary): {
  partI: {
    immediateCause: string;
    immediateCauseICD10: string;
    immediateCauseDuration: string;
    antecedentCause?: string;
    antecedentCauseICD10?: string;
    antecedentCauseDuration?: string;
    underlyingCause?: string;
    underlyingCauseICD10?: string;
    underlyingCauseDuration?: string;
  };
  partII: Array<{
    condition: string;
    icd10Code: string;
    duration: string;
  }>;
  clinicalCourseSummary: string;
  terminalEvents: string;
  nhmCategory: string;
  warnings: string[];
} {
  const diagnosis = patient.diagnosisAtDeath || patient.diagnosisAtDeath || patient.diagnosis || '';
  const isNeonatal = summary.patientProfile.isNeonatal;

  // Simple rule-based cause of death
  let immediateCause = diagnosis;
  let immediateCauseICD10 = '';
  let antecedentCause: string | undefined;
  let antecedentCauseICD10: string | undefined;
  let underlyingCause: string | undefined;
  let underlyingCauseICD10: string | undefined;

  const diagLower = diagnosis.toLowerCase();

  // Map common diagnoses to ICD-10
  if (diagLower.includes('sepsis')) {
    immediateCause = 'Neonatal sepsis';
    immediateCauseICD10 = 'P36.9';
    if (summary.gestationalAge.weeks < 37) {
      underlyingCause = `Prematurity (${summary.gestationalAge.weeks} weeks)`;
      underlyingCauseICD10 = 'P07.3';
    }
  } else if (diagLower.includes('rds') || diagLower.includes('respiratory distress')) {
    immediateCause = 'Respiratory Distress Syndrome';
    immediateCauseICD10 = 'P22.0';
    if (summary.gestationalAge.weeks < 37) {
      underlyingCause = `Prematurity (${summary.gestationalAge.weeks} weeks)`;
      underlyingCauseICD10 = 'P07.3';
    }
  } else if (diagLower.includes('asphyxia') || diagLower.includes('hie')) {
    immediateCause = 'Hypoxic Ischemic Encephalopathy';
    immediateCauseICD10 = 'P91.6';
    antecedentCause = 'Birth asphyxia';
    antecedentCauseICD10 = 'P21.0';
  } else if (diagLower.includes('prematurity') || diagLower.includes('preterm')) {
    immediateCause = 'Extreme prematurity with respiratory failure';
    immediateCauseICD10 = 'P07.2';
  }

  return {
    partI: {
      immediateCause,
      immediateCauseICD10,
      immediateCauseDuration: `${summary.clinicalCourse.totalDaysOfStay} days`,
      antecedentCause,
      antecedentCauseICD10,
      antecedentCauseDuration: antecedentCause ? 'Since birth' : undefined,
      underlyingCause,
      underlyingCauseICD10,
      underlyingCauseDuration: underlyingCause ? 'Since birth' : undefined
    },
    partII: [],
    clinicalCourseSummary: summary.clinicalCourse.overallAssessment,
    terminalEvents: 'Terminal cardiorespiratory failure despite resuscitative measures',
    nhmCategory: determineNHMDeathCategory(patient),
    warnings: ['Fallback cause of death analysis - manual review recommended']
  };
}

/**
 * Validate discharge readiness based on clinical criteria
 */
export const validateDischargeReadiness = (patient: Patient): {
  isReady: boolean;
  criteria: Array<{ criterion: string; met: boolean; notes?: string }>;
  warnings: string[];
  recommendations: string[];
} => {
  const summary = generateComprehensiveClinicalSummary(patient);

  if (!summary.dischargeReadiness) {
    // Patient already discharged or deceased
    return {
      isReady: true,
      criteria: [],
      warnings: [],
      recommendations: []
    };
  }

  return {
    isReady: summary.dischargeReadiness.isReady,
    criteria: summary.dischargeReadiness.criteria,
    warnings: summary.warnings.map(w => w.message),
    recommendations: summary.dischargeReadiness.recommendations
  };
};

// ============================================================================
// AI-POWERED BILINGUAL DISCHARGE ADVICE GENERATOR
// State-of-the-art multilingual discharge instructions in 22 Indian languages
// ============================================================================

export interface BilingualAdviceItem {
  english: string;
  regional: string;
}

export interface BilingualDischargeAdvice {
  advice: BilingualAdviceItem[];
  dangerSigns: BilingualAdviceItem[];
  followUpAdvice: BilingualAdviceItem[];
  language: string;
  languageNative: string;
}

/**
 * Generate bilingual discharge advice using AI
 * Supports all 22 Scheduled Languages of India + English
 */
export const generateBilingualDischargeAdvice = async (
  patient: Patient,
  language: string,
  languageNative: string
): Promise<BilingualDischargeAdvice> => {
  const isNICU = patient.unit === Unit.NICU || patient.unit === Unit.SNCU;
  const diagnosis = patient.primaryDiagnosis || 'Newborn care';

  const systemPrompt = `You are an expert neonatologist and medical translator.
Your task is to generate discharge advice for parents in BOTH English and ${language} (${languageNative}).
The advice must be:
1. SIMPLE - Any parent with basic education can understand
2. ACTIONABLE - Clear instructions, not vague suggestions
3. CULTURALLY APPROPRIATE - Suitable for Indian families
4. ACCURATE - Medically correct ${language} translations in native script`;

  const advicePrompt = `Generate 10 DISCHARGE ADVICE items for a ${isNICU ? 'NICU/premature baby' : 'hospitalized child'}.

Patient Diagnosis: ${diagnosis}

Each advice must be in this EXACT JSON format:
{
  "advice": [
    {"english": "English instruction here", "regional": "${languageNative} translation in native script"},
    ...10 items total
  ]
}

COVER THESE 10 TOPICS (in order):
1. FEEDING: Breastfeeding every 2-3 hours, no water/honey
2. WARMTH: Kangaroo Mother Care, skin-to-skin contact
3. HYGIENE: Handwashing before touching baby, umbilical care
4. VACCINATION: Complete all vaccines on schedule
5. FOLLOW-UP: Attend all doctor appointments
6. MEDICINES: Give medicines exactly as prescribed
7. SLEEP: Put baby on back to sleep, firm mattress
8. SKIN CARE: Keep clean and dry, change diapers often
9. DANGER SIGNS: Come to hospital immediately if danger signs
10. EMERGENCY: Save hospital number, call if worried

IMPORTANT:
- Use COMMAND form: "Feed baby..." not "Baby should be fed..."
- Keep each advice to 1-2 sentences maximum
- ${language} text MUST be in ${languageNative} script, not transliteration
- Make it simple enough for a village mother to understand

Return ONLY valid JSON, no other text.`;

  const dangerSignsPrompt = `Generate 10 DANGER SIGNS that parents must watch for.

Patient: ${isNICU ? 'Premature/sick newborn from NICU' : 'Child from PICU'}

Each danger sign in this EXACT JSON format:
{
  "dangerSigns": [
    {"english": "English description", "regional": "${languageNative} translation"},
    ...10 items total
  ]
}

COVER THESE 10 DANGER SIGNS:
1. Fast or difficult breathing
2. Not feeding well or refusing feeds
3. Fever (body hot) or body very cold
4. Yellow skin/eyes getting worse
5. Very sleepy, hard to wake up
6. Fits/convulsions or body stiffening
7. Umbilicus red, swollen, or smelly
8. Vomiting repeatedly or green vomit
9. Any bleeding from anywhere
10. No urine for more than 8 hours

IMPORTANT:
- Keep each sign short (one phrase)
- ${language} MUST be in native ${languageNative} script
- Use simple words any parent can understand

Return ONLY valid JSON, no other text.`;

  const followUpPrompt = `Generate 5 FOLLOW-UP ADVICE items for parents.

Patient: ${isNICU ? 'NICU baby' : 'PICU child'} with ${diagnosis}

JSON format:
{
  "followUpAdvice": [
    {"english": "English advice", "regional": "${languageNative} translation"},
    ...5 items
  ]
}

COVER:
1. First follow-up visit timing (usually 3-7 days)
2. What to bring (old papers, vaccination card)
3. Weight monitoring importance
4. Vaccination reminders
5. When to come earlier than scheduled

Return ONLY valid JSON.`;

  try {
    // Generate all three in parallel for speed
    const [adviceResponse, dangerResponse, followUpResponse] = await Promise.all([
      callOpenAI(advicePrompt, systemPrompt, {
        model: OPENAI_MODEL_FAST,
        temperature: 0.3,
        maxTokens: 2000,
        jsonMode: true
      }),
      callOpenAI(dangerSignsPrompt, systemPrompt, {
        model: OPENAI_MODEL_FAST,
        temperature: 0.2,
        maxTokens: 1500,
        jsonMode: true
      }),
      callOpenAI(followUpPrompt, systemPrompt, {
        model: OPENAI_MODEL_MINI,
        temperature: 0.2,
        maxTokens: 1000,
        jsonMode: true
      })
    ]);

    // Parse responses
    const adviceData = JSON.parse(adviceResponse);
    const dangerData = JSON.parse(dangerResponse);
    const followUpData = JSON.parse(followUpResponse);

    return {
      advice: adviceData.advice || [],
      dangerSigns: dangerData.dangerSigns || [],
      followUpAdvice: followUpData.followUpAdvice || [],
      language,
      languageNative
    };

  } catch (error) {
    console.error('Error generating bilingual advice:', error);

    // Return fallback English-only advice
    return {
      advice: [
        { english: 'Feed baby only breast milk every 2-3 hours. Do not give water or honey.', regional: '' },
        { english: 'Keep baby warm with skin-to-skin contact (Kangaroo care) daily.', regional: '' },
        { english: 'Wash hands with soap before touching baby. Keep umbilical cord dry.', regional: '' },
        { english: 'Complete all vaccinations on schedule. Do not miss any date.', regional: '' },
        { english: 'Bring baby for all follow-up visits as advised by doctor.', regional: '' },
        { english: 'Give medicines exactly as prescribed. Complete full course.', regional: '' },
        { english: 'Put baby to sleep on back. Use firm mattress, no pillows.', regional: '' },
        { english: 'Keep baby clean and dry. Change diapers frequently.', regional: '' },
        { english: 'Come to hospital immediately if you see any danger sign.', regional: '' },
        { english: 'Save hospital emergency number. Call if you are worried.', regional: '' }
      ],
      dangerSigns: [
        { english: 'Fast or difficult breathing', regional: '' },
        { english: 'Not feeding well or refusing feeds', regional: '' },
        { english: 'Fever (body hot) or body very cold', regional: '' },
        { english: 'Yellow skin or eyes getting worse', regional: '' },
        { english: 'Very sleepy, hard to wake for feeds', regional: '' },
        { english: 'Fits, jerky movements, body stiffening', regional: '' },
        { english: 'Umbilicus red, swollen, or bad smell', regional: '' },
        { english: 'Vomiting repeatedly or green vomit', regional: '' },
        { english: 'Any bleeding from any part of body', regional: '' },
        { english: 'No urine for more than 8 hours', regional: '' }
      ],
      followUpAdvice: [
        { english: 'First follow-up in 3-7 days as advised', regional: '' },
        { english: 'Bring all previous papers and vaccination card', regional: '' },
        { english: 'Baby will be weighed to check growth', regional: '' },
        { english: 'Ask about next vaccination date', regional: '' },
        { english: 'Come earlier if any problem or worry', regional: '' }
      ],
      language,
      languageNative
    };
  }
};

/**
 * Format bilingual advice for display (combines English + Regional)
 */
export const formatBilingualAdviceForDisplay = (
  items: BilingualAdviceItem[]
): string[] => {
  return items.map(item => {
    if (item.regional && item.regional.trim()) {
      return `${item.english}\n${item.regional}`;
    }
    return item.english;
  });
};

/**
 * Format bilingual advice as single line (English / Regional)
 */
export const formatBilingualAdviceSingleLine = (
  items: BilingualAdviceItem[]
): string[] => {
  return items.map(item => {
    if (item.regional && item.regional.trim()) {
      return `${item.english} / ${item.regional}`;
    }
    return item.english;
  });
};
