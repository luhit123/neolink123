rules_version = '2';
// Security rules for neolink database - Updated 2026-01-30
service cloud.firestore {
  match /databases/{database}/documents {

    // ==================== HELPER FUNCTIONS ====================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Get user document from users collection
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Check if user document exists in users collection
    function userDocExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // Check if user is SuperAdmin (document ID is email, not uid)
    function isSuperAdmin() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/superAdmins/$(request.auth.token.email));
    }

    // Check if user is the designated admin of an institution (via institutions collection)
    // This works even if the user's document in 'users' collection doesn't exist yet
    function isInstitutionAdminByEmail(institutionId) {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/institutions/$(institutionId)).data.adminEmail == request.auth.token.email;
    }

    // Check if user is Admin of specific institution (handles both 'admin' and 'Admin')
    // Falls back to checking institutions collection if users doc doesn't exist
    function isInstitutionAdmin(institutionId) {
      return isAuthenticated() &&
             (
               // Check via users collection
               (userDocExists() &&
                (getUserData().role == 'admin' || getUserData().role == 'Admin') &&
                getUserData().institutionId == institutionId)
               ||
               // Fallback: Check via institutions collection (adminEmail field)
               isInstitutionAdminByEmail(institutionId)
             );
    }

    // Check if user belongs to institution
    function belongsToInstitution(institutionId) {
      return isAuthenticated() &&
             userDocExists() &&
             getUserData().institutionId == institutionId;
    }

    // Check if user has specific role (handles case variations)
    // Returns false if user document doesn't exist
    function hasRole(role) {
      return isAuthenticated() &&
             userDocExists() &&
             (getUserData().role == role || getUserData().role.lower() == role.lower());
    }

    // Check if user is an admin (any case) - checks users collection
    function isAdmin() {
      return isAuthenticated() &&
             userDocExists() &&
             (getUserData().role == 'admin' || getUserData().role == 'Admin');
    }

    // Check if user can access patient data (belongs to same institution)
    function canAccessPatient(institutionId) {
      return isSuperAdmin() || belongsToInstitution(institutionId);
    }

    // Check if user is an Official (read-only access to all institutions)
    // Checks both users collection AND officials collection (by email) for flexibility
    function isOfficial() {
      return isAuthenticated() &&
             (
               // Check via users collection
               (userDocExists() && getUserData().role == 'Official') ||
               // Fallback: Check via officials collection (by email)
               exists(/databases/$(database)/documents/officials/$(request.auth.token.email))
             );
    }

    // Check if Official can view a specific institution
    // Officials can view all institutions or only assigned ones
    function officialCanViewInstitution(institutionId) {
      return isOfficial() &&
             (getUserData().canViewAllInstitutions == true ||
              (getUserData().assignedInstitutionIds != null &&
               institutionId in getUserData().assignedInstitutionIds));
    }

    // Validate required fields for audit trail
    function hasAuditFields() {
      return request.resource.data.keys().hasAll(['updatedAt', 'updatedBy']);
    }

    // ==================== SUPER ADMIN COLLECTION ====================
    match /superAdmins/{adminId} {
      // Allow authenticated users to check if they are a superadmin
      // This is needed for the login flow to determine user role
      allow read: if isAuthenticated();
      allow write: if false; // Managed via Firebase Console or backend only
    }

    // ==================== INSTITUTIONS ====================
    match /institutions/{institutionId} {
      // Allow read for login lookup (query by userID) and authenticated users
      allow read: if true; // Allow reads for login lookup flow
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin() || isInstitutionAdmin(institutionId);
      allow delete: if isSuperAdmin();

      // Bed capacity subcollection
      match /bedCapacity/{docId} {
        allow read: if canAccessPatient(institutionId);
        allow write: if isSuperAdmin() || isInstitutionAdmin(institutionId);
      }
    }

    // ==================== USERS ====================
    match /users/{userId} {
      // Users can read their own data, admins can read users in their institution
      allow read: if isAuthenticated() &&
                    (request.auth.uid == userId ||
                     isSuperAdmin() ||
                     (getUserData().role == 'admin' &&
                      resource.data.institutionId == getUserData().institutionId));

      // Users can create their own profile document (needed for first login)
      // OR admins can create users for their institution
      allow create: if isAuthenticated() &&
                      (request.auth.uid == userId ||
                       isSuperAdmin() ||
                       (hasRole('admin') && request.resource.data.institutionId == getUserData().institutionId));

      // Users can update their own non-critical fields, admins can update users
      allow update: if isAuthenticated() &&
                      (request.auth.uid == userId ||
                       isSuperAdmin() ||
                       (hasRole('admin') && resource.data.institutionId == getUserData().institutionId));

      // Only SuperAdmins can delete users
      allow delete: if isSuperAdmin();
    }

    // ==================== PATIENTS (PHI - Protected Health Information) ====================
    match /patients/{patientId} {
      // Read: Must be authenticated and belong to same institution
      // Officials can also read (view-only access)
      allow read: if isAuthenticated() &&
                    (isSuperAdmin() ||
                     resource.data.institutionId == getUserData().institutionId ||
                     officialCanViewInstitution(resource.data.institutionId));

      // Create: Must be authenticated, belong to institution, and include audit fields
      allow create: if isAuthenticated() &&
                      (isSuperAdmin() ||
                       request.resource.data.institutionId == getUserData().institutionId) &&
                      request.resource.data.keys().hasAll(['createdAt', 'createdBy', 'institutionId']);

      // Update: Must be authenticated and belong to institution
      // Note: updatedAt/updatedBy are recommended but not strictly required to allow status changes
      allow update: if isAuthenticated() &&
                      (isSuperAdmin() ||
                       resource.data.institutionId == getUserData().institutionId);

      // Delete: Only admins can delete (soft delete preferred)
      allow delete: if isSuperAdmin() ||
                      (hasRole('admin') && resource.data.institutionId == getUserData().institutionId);

      // Progress Notes subcollection
      match /progressNotes/{noteId} {
        allow read: if isAuthenticated() &&
                      (isSuperAdmin() ||
                       get(/databases/$(database)/documents/patients/$(patientId)).data.institutionId == getUserData().institutionId ||
                       officialCanViewInstitution(get(/databases/$(database)/documents/patients/$(patientId)).data.institutionId));
        allow create, update: if isAuthenticated() &&
                                (isSuperAdmin() ||
                                 get(/databases/$(database)/documents/patients/$(patientId)).data.institutionId == getUserData().institutionId);
        allow delete: if isSuperAdmin() || hasRole('admin');
      }

      // Clinical Notes subcollection
      match /clinicalNotes/{noteId} {
        allow read: if isAuthenticated() &&
                      (isSuperAdmin() ||
                       get(/databases/$(database)/documents/patients/$(patientId)).data.institutionId == getUserData().institutionId ||
                       officialCanViewInstitution(get(/databases/$(database)/documents/patients/$(patientId)).data.institutionId));
        allow create, update: if isAuthenticated() &&
                                (isSuperAdmin() ||
                                 get(/databases/$(database)/documents/patients/$(patientId)).data.institutionId == getUserData().institutionId);
        allow delete: if isSuperAdmin() || hasRole('admin');
      }
    }

    // ==================== INSTITUTION-SCOPED PATIENTS ====================
    match /institutions/{institutionId}/patients/{patientId} {
      allow read: if canAccessPatient(institutionId);
      allow create: if isAuthenticated() &&
                      (isSuperAdmin() || belongsToInstitution(institutionId)) &&
                      request.resource.data.keys().hasAll(['createdAt', 'createdBy']);
      allow update: if isAuthenticated() &&
                      (isSuperAdmin() || belongsToInstitution(institutionId));
      allow delete: if isSuperAdmin() || isInstitutionAdmin(institutionId);

      // Progress Notes
      match /progressNotes/{noteId} {
        allow read, write: if canAccessPatient(institutionId);
      }

      // Clinical Notes
      match /clinicalNotes/{noteId} {
        allow read, write: if canAccessPatient(institutionId);
      }
    }

    // ==================== REFERRALS ====================
    match /referrals/{referralId} {
      // Helper to get user's institution ID (supports both users collection and auth token claims)
      // First tries users collection, falls back to auth token custom claims
      function getUserInstitutionId() {
        return userDocExists() ? getUserData().institutionId : request.auth.token.institutionId;
      }

      // Check if user belongs to institution (supports both users doc and token claims)
      function canAccessInstitution(instId) {
        return (userDocExists() && getUserData().institutionId == instId) ||
               (request.auth.token.institutionId == instId);
      }

      // Users can read referrals to/from their institution
      allow read: if isAuthenticated() &&
                    (isSuperAdmin() ||
                     canAccessInstitution(resource.data.fromInstitutionId) ||
                     canAccessInstitution(resource.data.toInstitutionId));

      // Authenticated users from sending institution can create
      // Supports both users collection and auth token claims for institutionId
      allow create: if isAuthenticated() &&
                      (isSuperAdmin() ||
                       canAccessInstitution(request.resource.data.fromInstitutionId));

      // Both sending and receiving institution can update (for status changes, accepting/rejecting)
      allow update: if isAuthenticated() &&
                      (isSuperAdmin() ||
                       canAccessInstitution(resource.data.fromInstitutionId) ||
                       canAccessInstitution(resource.data.toInstitutionId));

      allow delete: if isSuperAdmin();
    }

    // ==================== AUDIT LOGS (Immutable) ====================
    match /auditLogs/{logId} {
      // Only authenticated users can create audit logs
      allow create: if isAuthenticated();

      // SuperAdmins and institution admins can read logs for their institution
      allow read: if isSuperAdmin() ||
                    (hasRole('admin') && resource.data.institutionId == getUserData().institutionId);

      // Audit logs are IMMUTABLE - no updates or deletes
      allow update, delete: if false;
    }

    // ==================== APPROVED USERS (for login lookup) ====================
    match /approved_users/{docId} {
      // Allow reading for login lookup (query by userID or email)
      // This is needed for the signInWithUserID flow
      allow read: if true; // Allow unauthenticated reads for login lookup

      // Only SuperAdmins and institution admins can create/update/delete
      // Uses isInstitutionAdmin which checks both users collection AND institutions collection (adminEmail)
      allow create: if isSuperAdmin() ||
                      isInstitutionAdmin(request.resource.data.institutionId);
      allow update: if isSuperAdmin() ||
                      isInstitutionAdmin(resource.data.institutionId);
      allow delete: if isSuperAdmin();
    }

    // ==================== SYSTEM CONFIGURATION ====================
    match /systemConfig/{docId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin();
    }

    // ==================== GLOBAL CONFIGURATION (AI providers, etc) ====================
    match /globalConfig/{docId} {
      // All authenticated users can read global config (needed for AI provider selection)
      allow read: if isAuthenticated();
      // Only SuperAdmins can update global config
      allow write: if isSuperAdmin();
    }

    // ==================== USER LOOKUP TABLE (O(1) Authentication) ====================
    match /userLookup/{identifier} {
      // Lookup table is managed by Cloud Functions only
      // Allows O(1) user lookup during authentication
      allow read, write: if false; // Only via Cloud Functions (admin SDK bypasses rules)
    }

    // ==================== ANALYTICS (Read-only for most) ====================
    match /analytics/{docId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin();
    }

    // ==================== ADMISSION INDICATIONS ====================
    match /admissionIndications/{indicationId} {
      // All authenticated users can read indications (needed for patient admission forms)
      allow read: if isAuthenticated();
      // Only SuperAdmins can create/update/delete indications
      allow create, update, delete: if isSuperAdmin();
    }

    // ==================== OBSERVATION INDICATIONS ====================
    match /observationIndications/{indicationId} {
      // All authenticated users can read indications (needed for observation patient forms)
      allow read: if isAuthenticated();
      // Only SuperAdmins can create/update/delete indications
      allow create, update, delete: if isSuperAdmin();
    }

    // ==================== MEDICATIONS DATABASE ====================
    match /medications/{medicationId} {
      // All authenticated users can read medications (needed for medication orders)
      allow read: if isAuthenticated();
      // Only SuperAdmins can create/update/delete medications
      allow create, update, delete: if isSuperAdmin();
    }

    // ==================== PASSWORD RESET REQUESTS ====================
    match /passwordResetRequests/{requestId} {
      // Users can create their own password reset requests
      allow create: if isAuthenticated() &&
                      request.resource.data.userId == request.auth.uid;
      // Users can read their own requests, admins can read for their institution
      allow read: if isSuperAdmin() ||
                    (isAuthenticated() && resource.data.userId == request.auth.uid) ||
                    (hasRole('admin') && resource.data.institutionId == getUserData().institutionId);
      // Only SuperAdmins can update (approve/reject)
      allow update: if isSuperAdmin();
      // Only SuperAdmins can delete
      allow delete: if isSuperAdmin();
    }

    // ==================== ANNOUNCEMENTS ====================
    match /announcements/{announcementId} {
      // All authenticated users can read announcements
      allow read: if isAuthenticated();
      // Only SuperAdmins can create/update/delete announcements
      allow create, update, delete: if isSuperAdmin();
    }

    // ==================== OBSERVATION PATIENTS ====================
    match /observationPatients/{patientId} {
      // Officials can read observation patients (view-only)
      allow read: if isAuthenticated() &&
                    (isSuperAdmin() ||
                     resource.data.institutionId == getUserData().institutionId ||
                     officialCanViewInstitution(resource.data.institutionId));
      allow create: if isAuthenticated() &&
                      (isSuperAdmin() ||
                       request.resource.data.institutionId == getUserData().institutionId);
      allow update: if isAuthenticated() &&
                      (isSuperAdmin() ||
                       resource.data.institutionId == getUserData().institutionId);
      allow delete: if isSuperAdmin() ||
                      (hasRole('admin') && resource.data.institutionId == getUserData().institutionId);
    }

    // ==================== OFFICIALS (Government/Health Officials) ====================
    match /officials/{officialId} {
      // Allow reading for login lookup (query by userID or email)
      allow read: if true; // Allow unauthenticated reads for login lookup

      // Only SuperAdmins can create/update/delete officials
      allow create, update, delete: if isSuperAdmin();
    }

    // ==================== REPORT REQUESTS (Official to Admin communication) ====================
    match /reportRequests/{requestId} {
      // Officials can read their own requests
      // Admins can read requests for their institution
      // SuperAdmins can read all
      allow read: if isAuthenticated() &&
                    (isSuperAdmin() ||
                     resource.data.requesterEmail == request.auth.token.email ||
                     isInstitutionAdmin(resource.data.institutionId));

      // Only Officials can create report requests
      allow create: if isAuthenticated() &&
                      isOfficial() &&
                      request.resource.data.requesterEmail == request.auth.token.email;

      // Officials can update their own requests (e.g., mark as read)
      // Admins can update requests for their institution (respond, update status)
      allow update: if isAuthenticated() &&
                      (isSuperAdmin() ||
                       (isOfficial() && resource.data.requesterEmail == request.auth.token.email) ||
                       isInstitutionAdmin(resource.data.institutionId));

      // Only SuperAdmins can delete
      allow delete: if isSuperAdmin();
    }

    // ==================== REPORT RESPONSES (Admin responses to Officials) ====================
    match /reportResponses/{responseId} {
      // Officials can read responses to their requests
      // Admins can read responses they created
      // SuperAdmins can read all
      allow read: if isAuthenticated() &&
                    (isSuperAdmin() ||
                     resource.data.responderEmail == request.auth.token.email ||
                     // Check if the official owns the parent request
                     get(/databases/$(database)/documents/reportRequests/$(resource.data.requestId)).data.requesterEmail == request.auth.token.email);

      // Only Admins can create responses
      allow create: if isAuthenticated() &&
                      (isSuperAdmin() ||
                       isInstitutionAdmin(get(/databases/$(database)/documents/reportRequests/$(request.resource.data.requestId)).data.institutionId));

      // Responses can be updated (e.g., mark as read)
      allow update: if isAuthenticated() &&
                      (isSuperAdmin() ||
                       resource.data.responderEmail == request.auth.token.email ||
                       get(/databases/$(database)/documents/reportRequests/$(resource.data.requestId)).data.requesterEmail == request.auth.token.email);

      // Only SuperAdmins can delete
      allow delete: if isSuperAdmin();
    }

    // ==================== PENDING ACCESS REQUESTS ====================
    match /pending_access_requests/{requestId} {
      // Any authenticated user can create a request (to request access to the system)
      allow create: if isAuthenticated() &&
                      request.resource.data.uid == request.auth.uid &&
                      request.resource.data.email == request.auth.token.email;

      // Users can read their own pending requests
      // SuperAdmins can read all requests
      // Institution admins can read requests (to approve users for their institution)
      allow read: if isAuthenticated() &&
                    (resource.data.uid == request.auth.uid ||
                     isSuperAdmin() ||
                     hasRole('admin'));

      // Only SuperAdmins and institution admins can update (approve/reject)
      allow update: if isSuperAdmin() || hasRole('admin');

      // Only SuperAdmins can delete
      allow delete: if isSuperAdmin();
    }

    // ==================== AUTHENTICATION AUDIT LOGS (Enterprise Security) ====================
    match /authAuditLogs/{logId} {
      // Only Cloud Functions can create audit logs (via admin SDK)
      // SuperAdmins can read audit logs
      allow read: if isSuperAdmin();
      allow create: if false; // Only via Cloud Functions (admin SDK bypasses rules)
      allow update, delete: if false; // Immutable
    }

    // ==================== RATE LIMITS (Enterprise Security) ====================
    match /rateLimits/{identifier} {
      // Rate limits are managed by Cloud Functions only
      allow read, write: if false; // Only via Cloud Functions (admin SDK bypasses rules)
    }

    // ==================== DISTRICT ADMINS ====================
    match /districtAdmins/{adminId} {
      // Allow reading for login lookup
      // SECURITY NOTE: passwordHash is stored but never exposed to client
      // (Cloud Functions handle authentication server-side)
      allow read: if true; // Allow unauthenticated reads for login lookup

      // Only SuperAdmins can manage district admins
      allow create, update, delete: if isSuperAdmin();
    }

    // ==================== DEFAULT DENY ====================
    // Any path not explicitly matched is denied
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
